<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>更改配送区域</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/businessHours.css" />
	</head>
	<body>
		<div class="topBack">
			<img class="bg" src="../image/bg_003.png" alt="" />
		</div>
		<div class="header" id="header">
			<div class="backIcon" onclick="goBack();"><img src="../image/deliver/icon_back.png" alt="" />
			</div>
			<div class="title">
				<span>营业时段</span>
			</div>
			<!--<div class="saveBtn" id="saveBtn">
			<span>保 存</span>
			</div>-->
		</div>
		<div class="middleInfo">
			<div class="h10"></div>
			<div class="h10"></div>
			<div class="h1"></div>
			<div class="item">
				<div class="itemName">
					<span>营业时段</span>
				</div>
				<div class="content" onclick="openTimeSelect();">
					<input type="button" id="timeType" value="" onchange="" disabled="disabled">
					</input >
				</div>
			</div>
			<div class="h1"></div>
			<div class="item">
				<div class="itemName">
					<span>营业时段</span>
				</div>
				<div class="content" onclick="openTimeSelect();">
					<input type="text" id="officeHours" value="" onchange="" disabled="disabled">
					</input >
				</div>
			</div>
			<div class="h1"></div>
		</div>
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script>
		var timeTypeArray = new Array();
		apiready = function() {
			api.addEventListener({
				name : 'keyback'
			}, function(ret, err) {
				goBack();
			});
			updateCarBusinessHours();
		}
		function updateCarBusinessHours() {
			window.header = $api.byId('header');
			$api.fixStatusBar(header);
			var query = new AV.Query(CafeCar);
//			query.equalTo('owner', AV.Object.createWithoutData('_User', '554ed54be4b031c7f9d07691'));
            query.equalTo('owner', AV.User.current());
			query.first().then(function(carObj) {
				if (carObj) {
					var current = carObj.get('currentOfficeHours'), timeArray = carObj.get('officeHours');
					console.log(current + '---' + timeArray);
					for ( i = 0; i < timeArray.length; i++) {
						if (timeArray[i].name == current) {
							var timeType = timeArray[i].name, officeHours = timeArray[i].officeHours;
						}
						var tmp = {
							name : timeArray[i].name,
							hours : timeArray[i].officeHours[0] + '----' + timeArray[i].officeHours[1]
						}
						timeTypeArray.push(tmp);
					}
					document.getElementById('timeType').value = timeType;
					document.getElementById('officeHours').value = officeHours[0] + '----' + officeHours[1];
				} else {
					document.getElementById('timeType').value = '暂无配送区域';
					document.getElementById('officeHours').value = '暂无配送区域';
				}
			}).catch(function(err) {
				console.log(JSON.stringify(err));
			});
		}

		function alterOrNot(current) {
			api.confirm({
				title : '提示',
				msg : '是否确定设置营业时段为：' + current,
				buttons : ['取消', '确定']
			}, function(ret, err) {
				if (ret.buttonIndex == 2) {
					alterCurrentOfficeHours(current);
				}
			});
		}

		function alterCurrentOfficeHours(current) {
			console.log('alterCurrentOfficeHours in  ' + current);
			api.showProgress({
				title : '营业时段更新中...',
				modal : false
			});
			var query = new AV.Query(CafeCar);
//			query.equalTo('owner', AV.Object.createWithoutData('_User', '554ed54be4b031c7f9d07691'));
            query.equalTo('owner', AV.User.current());
			query.first().then(function(carObj) {
				if (carObj) {
					carObj.set('currentOfficeHours', current);
					carObj.save().then(function(ret) {
						api.hideProgress();
						//
						var current = ret.get('currentOfficeHours'), timeArray = ret.get('officeHours');
						console.log(current + '---' + timeArray);
						for ( i = 0; i < timeArray.length; i++) {
							if (timeArray[i].name == current) {
								var timeType = timeArray[i].name, officeHours = timeArray[i].officeHours;
							}
						}
						document.getElementById('timeType').value = timeType;
						document.getElementById('officeHours').value = officeHours[0] + '----' + officeHours[1];
//						goBack();
					}).catch(function(error) {
						api.hideProgress();
						errorAlert(error);
					});
				} else if (!carObj) {
					api.hideProgress();
					api.toast({
						msg : '当前登录无效，请重新登录',
						location : 'middle',
						duration : 2000
					});
					AV.User.logOut();
					api.openWin({
						name : 'login',
						url : '../new_login.html',
						opaque : true, // 页面不透明
						bounces : false, // 不允许页面弹动
						reload : true,
						delay : 2000
					});
				}
			}).catch(function(error) {
				api.hideProgress();
				errorAlert(error);
			});
		}

		function openTimeSelect() {
			api.lockSlidPane();
			$api.setStorage('timeSelect', true)
			api.openFrame({
				name : 'timeSelect',
				url : './timeSelect.html',
				pageParam : {
					times : timeTypeArray
				},
				bounces : false,
				opaque : false,
				bgColor : 'rgba(51,51,51,0.6)',
				vScrollBarEnabled : false,
				hScrollBarEnabled : false,
				scrollEnabled : false,
				rect : {
					x : 0,
					y : 0,
					w : 'auto',
					h : 'auto'
				}
			}, function(ret, err) {
			});
		}

		function goBack() {
			api.closeWin({
			});
		}
	</script>
</html>
