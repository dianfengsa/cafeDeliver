<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>中转点选择</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/manSelector.css">
	</head>
	<body>
		<div class="selector">
			<ul id="manItems" style="text-align: center;">
				<div class="onDutyMenList" id="onDutyMenListDiv" ></div>
				<div class="emptyInventory" id="emptyDiv" hidden>
					<img src="../image/empty_page_nothing.png" alt="" />
					<div class="emptyAlert" id="emptyAlertDiv">
						暂无中转点
					</div>
				</div>
			</ul>
			<div style="text-align: center;">
				<button style="height: 44px;width: 40%;background-color: #EF5B00;border-radius: 5px;line-height: 44px;" id="goBackBtn" tapmode="pressGoBackBtn" onclick="goBack();">
					<b style="color:white;font-size: 20px;">返 回</b>
				</button>
			</div>
		</div>
		<script type="text/template" charset="utf-8" id="template_selector">
			{{ if(it && it.length>0){ }}
			{{ for(var i=0; i<it.length; i++){ }}
			<li>
			<div class="item" tapmode="presshover" onclick="ensure('{{=it[i].kitchenId}}', '{{=it[i].name}}', '{{=it[i].name}}');">
			<span>{{=it[i].name}}</span>
			<span>|{{=it[i].name()}}<span>
			</div>
			</li>
			{{ } }}
			{{ } }}
		</script>
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/doT.min.js"></script>
	<script type="text/javascript" src="../script/ajpush.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script>
		var listViewObj;
		apiready = function() {
			listViewObj = api.require('listView');
			uiListViewObj = api.require('listView');
			var header = $api.byId('manItems');
			$api.fixStatusBar(header);
			var pageParam = api.pageParam;
			if (AV.User.current()) {
				api.showProgress({
					title : '中转点获取中...',
					modal : false
				});
				loadingDeliveryMen(pageParam.transPoints);
			} else {
				api.toast({
					msg : '当前登录无效，请重新登录',
					location : 'middle',
					duration : 2000
				});
				AV.User.logOut();
				api.openWin({
					name : 'login',
					url : '../new_login.html',
					opaque : true, // 页面不透明
					bounces : false, // 不允许页面弹动
					reload : true,
					delay : 2000
				});
			}
		}
		function loadingDeliveryMen(transPoints) {
			//			var points = $api.getStorage("transPoints");
			//			console.log("points>>>" + JSON.stringify(points))
			insertOrderItem(transPoints);
		}

		function insertOrderItem(items) {
			console.log("items>>>" + JSON.stringify(items))
			var data = new Array();
			for (var i = 0; i < items.length; i++) {
				data.push({
					title : items[i].name,
					subTitle : items[i].name,
					titleSize : 20,
					subTitleSize : 16
				});
			}
			intiTimeSelect(data, items);
		}

		function intiTimeSelect(data, items) {
			var cellHeight = 60;
			var totalCellHeight = data.length * cellHeight;
			var fHeight = api.frameHeight * 0.1;
			var height = api.frameHeight * 0.7;
			var width = api.frameWidth;
			listViewObj.open({
				"x" : Math.ceil(width * 0.1),
				"y" : totalCellHeight > height ? Math.ceil(fHeight) : Math.ceil((api.frameHeight - totalCellHeight) / 2),
				"w" : Math.ceil(width * 0.8),
				"h" : totalCellHeight > height ? Math.ceil(height) : totalCellHeight,
				"cellBgColor" : "#FFF",
				"cellSelectColor" : "#f5f5f5",
				"cellHeight" : cellHeight,
				"data" : data
			}, function(ret, err) {
				if (ret.eventType !== "open") {
					//					console.log(JSON.stringify(ret));
					//					console.log(JSON.stringify(items[ret.index]));
					var manItem = items[ret.index];
					ensure(manItem.kitchenId, manItem.name);
				}
			});
		}

		function goBack() {
			$api.rmStorage("adv");
			api.hideProgress();
			listViewObj.hide();
			api.closeFrame({
				name : 'adviceSelect'
			});
		}

		function ensure(kitchenId, manName) {
			if (api.pageParam) {
//			console.log("api.pageParam.orderId, kitchenId>>>>"+api.pageParam.orderId+"<<<:>>>"+kitchenId)
				var query = new AV.Query(Order);
				query.get(api.pageParam.orderId).then(function(order) {
					api.confirm({
						title : '设置提醒',
						msg : '是否将 <<' + manName + '>>设置为中转点 ',
						buttons : ['取消', '确定']
					}, function(ret, err) {
						if (ret.buttonIndex == 2) {
							saveDeliveryMan(api.pageParam.orderId, kitchenId);
						}
					});
				}).catch(function(error) {
					errorAlert(error);
				});
			}
		}

		function saveDeliveryMan(orderId, kitchenId) {
			api.showProgress({
				title : '设置中转点...',
				modal : true
			});
			console.log("orderId>>>"+orderId +"<<<<kitchenId>>>>"+kitchenId)
			AV.Cloud.run("changeOrderTransPoint", {
				"orderId" : orderId,
				"kitchenId" : kitchenId
			}).then(function(ret) {
				console.log("ret>>>" + JSON.stringify(ret))
				api.execScript({
					name : 'homeSlide', 
					script : 'getOrdersByType();'
				}); 
				api.hideProgress();
				api.toast({
					msg : '设置成功！',
					location : 'middle',
					duration : 1000
				});
				setTimeout(function() {
					goBack();
				}, 1000);
			}).catch(function(error) {
				console.log(JSON.stringify(error));
			});
		}
	</script>
</html>
