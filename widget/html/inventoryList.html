<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>货存列表</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/inventoryList.css" />
	</head>
	<body>
		<script type="text/template" id="template_dishItem">
			{{ if(it && it.length>0){ }}
			{{ for(var i=0; i<it.length; i++){ }}
			<div class="item" id="itemID{{=it[i].No}}">
			<div class="inventory">
			<div class="dishInfo">
			<div class="dishName">
			<span id="nameID{{=it[i].No}}">{{=it[i].name}}</span>
			</div>
			{{ if(it[i].status=='上架'){ }}
			<div class="price">
			￥<span>{{=changeTwoDecimal_f(it[i].price)}}</span>
			</div>
			{{ }else if(it[i].status=='下架'){ }}
			<div class="price-off">
			￥<span>{{=changeTwoDecimal_f(it[i].price)}}</span>
			</div>
			{{ } }}
			</div>
			<div class="manage">
			<div class="amount">
			货存 <span id="amountID{{=it[i].No}}">{{=it[i].num}}</span> 份
			</div>
			{{ if(it[i].status=='上架'){ }}
			<div style="width:70px;height:30px;">
			<div class="subBtn" onclick="inputSubDishAmount('{{=it[i].No}}');">
			<img src="../image/icon/sub.png" alt="" />
			</div>
			<div class="plusBtn" onclick="inputAddDishAmount('{{=it[i].No}}');">
			<img src="../image/icon/plus.png" alt="" />
			</div>
			</div>
			{{ }else if(it[i].status=='下架'){ }}
			<div style="width:70px;height:30px;">
			<div class="subBtn" onclick="inputSubDishAmount('{{=it[i].No}}');">
			<img src="../image/icon/sub.png" alt="" />
			</div>
			<div class="plusBtn" onclick="">
			<img src="../image/icon/plus_gray.png" alt="" />
			</div>
			</div>
			{{ } }}
			</div>
			</div>
			</div>
			<div class="h1"></div>
			{{ } }}
			{{ } }}
		</script>
		<div class="inventoryList" id="inventoryListDiv"></div>
		<div class="emptyInventory" id="emptyDiv" hidden>
			<img src="../image/empty_page_nothing.png" alt="" />
			<div class="emptyAlert" id="emptyAlertDiv">
				暂无货存
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script type="text/javascript" src="../script/doT.min.js"></script>
	<script>
		apiready = function() {
			api.setRefreshHeaderInfo({
				visible : true,
				bgColor : '#EFEFEF',
				//				textColor : '#fff',
				textDown : '刷新货存..',
				textUp : '刷新货存..',
				textLoading : '数据加载中..'
			}, function(ret, err) {
				//从服务器加载数据，完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
				loadingInventory().then(function() {
					api.refreshHeaderLoadDone();
				}).catch(function(error) {
					api.refreshHeaderLoadDone();
					errorAlert(error);
				});
			});
			if (AV.User.current()) {
				api.showProgress({
					title : '货存列表获取中...',
					modal : false
				});
				loadingInventory().then(function() {
					api.hideProgress();
				}).catch(function(error) {
					api.hideProgress();
					errorAlert(error);
				});
			} else {
				api.toast({
					msg : '当前登录无效，请重新登录',
					location : 'middle',
					duration : 2000
				});
				AV.User.logOut();
				api.openWin({
					name : 'login',
					url : '../new_login.html',
					opaque : true, // 页面不透明
					bounces : false, // 不允许页面弹动
					reload : true,
					delay : 2000
				});
			}
		}
		function loadingInventory() {
			var queryMan = new AV.Query(DeliveryMan);
			queryMan.equalTo('owner', AV.User.current());
			queryMan.include("cafeCar");
			return queryMan.first().then(function(manObj) {
				if (manObj) {
					var carObj = manObj.cafeCar();
					return getDishes(carObj);
				} else {
					AV.Promise.error("没有找到送餐员");
				}
			}).catch(function(error) {
				console.log(JSON.stringify(error));
				return AV.Promise.error(error);
			});
		}

		function getDishes(carObj) {
			return new AV.Promise(function(resolve, reject) {
				if (!carObj) {
					document.getElementById('inventoryListDiv').innerHTML = '';
					document.getElementById('emptyDiv').hidden = false;
					return resolve();
				} else if (carObj && !carObj.cart()) {
					document.getElementById('inventoryListDiv').innerHTML = '';
					document.getElementById('emptyDiv').hidden = false;
					return resolve();
				} else if (carObj && carObj.cart()) {
					document.getElementById('emptyDiv').hidden = true;
					return AV.Cloud.run("getCarInventory", {
						"cafecarId" : carObj.id
					}).then(function(dishes) {
						console.log("dishes>>>" + JSON.stringify(dishes));
						insertOrderItem(dishes);
						return resolve();
					}).catch(function(error) {
						return reject(error);
					});
				}
			});
		}

		function insertOrderItem(items) {
			var template = document.getElementById('template_dishItem').innerHTML;
			document.getElementById('inventoryListDiv').innerHTML = doT.template( template )(items);
		}

		function inputAddDishAmount(No) {
			var name = document.getElementById('nameID' + No).innerHTML;
			var num = document.getElementById('amountID' + No).innerHTML;
			var dish = {
				No : No,
				name : name,
				num : num
			};
			var addAmount;
			api.prompt({
				title : '请输入增加数量',
				msg : dish.name + ' 现有库存量： ' + dish.num + ' 份',
				text : '',
				type : 'number',
				buttons : ['取消', '确定']
			}, function(ret, err) {
				if (ret.buttonIndex == 2) {
					addAmount = parseInt(ret.text);
					if (addAmount <= 0) {
						api.toast({
							msg : '增加数量不能小于等于0',
							location : 'bottom',
							duration : 1000
						});
					} else if (addAmount > 500) {
						api.toast({
							msg : '每次增加数量不能大于500份',
							location : 'bottom',
							duration : 1000
						});
					} else {
						api.confirm({
							title : '增加库存',
							msg : '确定增加 ' + addAmount + ' 份 ' + dish.name,
							buttons : ['取消', '确定']
						}, function(ret, err) {
							if (ret.buttonIndex == 2) {
								addDishAmount(dish, addAmount);
							}
						});
					}
				}
			});
		}

		function inputSubDishAmount(No) {
			var name = document.getElementById('nameID' + No).innerHTML;
			var num = document.getElementById('amountID' + No).innerHTML;
			var dish = {
				No : No,
				name : name,
				num : num
			};
			var subAmount;
			api.prompt({
				title : '请输入删减数量',
				msg : dish.name + ' 现有库存量： ' + dish.num + ' 份',
				text : '',
				type : 'number',
				buttons : ['取消', '确定']
			}, function(ret, err) {
				if (ret.buttonIndex == 2) {
					subAmount = parseInt(ret.text);
					if (subAmount <= 0) {
						api.toast({
							msg : '删减数量不能小于等于0',
							location : 'bottom',
							duration : 1000
						});
					} else if (subAmount > dish.num) {
						api.toast({
							msg : '删减数量不能大于库存量',
							location : 'bottom',
							duration : 1000
						});
					} else {
						api.confirm({
							title : '删减库存',
							msg : '确定减去 ' + subAmount + ' 份 ' + dish.name,
							buttons : ['取消', '确定']
						}, function(ret, err) {
							if (ret.buttonIndex == 2) {
								subDishAmount(dish, subAmount);
							}
						});
					}
				}
			});
		}

		function addDishAmount(dish, amount) {
			api.showProgress({
				title : '增加货存中...',
				modal : true
			});
			var queryMan = new AV.Query(DeliveryMan);
			queryMan.equalTo('owner', AV.User.current());
			queryMan.include("cafeCar");
			return queryMan.first().then(function(manObj) {
				var carObj = manObj.cafeCar();
				if (carObj) {
					var cart = new Object();
					cart[dish.No] = Number(amount);
					var request = {
						cafecarId : carObj.id,
						manId : manObj.id,
						cart : cart,
						officeHoursType : carObj.currentOfficeHours(),
						type : "调整库存",
						description : "调整库存--加库存"
					};
					return AV.Cloud.run("createException", request);
				} else if (!carObj) {
					api.hideProgress();
					api.toast({
						msg : '当前登录无效，请重新登录',
						location : 'middle',
						duration : 2000
					});
					AV.User.logOut();
					api.openWin({
						name : 'login',
						url : '../new_login.html',
						opaque : true, // 页面不透明
						bounces : false, // 不允许页面弹动
						reload : true,
						delay : 2000
					});
				}
			}).then(function(excption) {
				api.hideProgress();
				document.getElementById('amountID' + dish.No).innerHTML = accAdd(document.getElementById('amountID' + dish.No).innerHTML,excption.cart[dish.No]);
				api.toast({
					msg : '成功添加 ' + amount + ' 份 ' + dish.name,
					location : 'bottom',
					duration : 1000
				});
			}).catch(function(error) {
				api.hideProgress();
				errorAlert(error);
			});
		}

		function subDishAmount(dish, amount) {
			api.showProgress({
				title : '减少货存中...',
				modal : true
			});
			var queryMan = new AV.Query(DeliveryMan);
			queryMan.equalTo('owner', AV.User.current());
			queryMan.include("cafeCar");
			return queryMan.first().then(function(manObj) {
				var carObj = manObj.cafeCar();
				if (carObj) {
					var cart = new Object();
					cart[dish.No] = -Number(amount);
					var request = {
						cafecarId : carObj.id,
						manId : manObj.id,
						cart : cart,
						officeHoursType : carObj.currentOfficeHours(),
						type : "调整库存",
						description : "调整库存--减库存"
					};
					return AV.Cloud.run("createException", request);
				} else if (!carObj) {
					api.hideProgress();
					api.toast({
						msg : '当前登录无效，请重新登录',
						location : 'middle',
						duration : 2000
					});
					AV.User.logOut();
					api.openWin({
						name : 'login',
						url : '../new_login.html',
						opaque : true, // 页面不透明
						bounces : false, // 不允许页面弹动
						reload : true,
						delay : 2000
					});
				}
			}).then(function(excption) {
				console.log(JSON.stringify(excption));
				api.hideProgress();
				document.getElementById('amountID' + dish.No).innerHTML = accAdd(document.getElementById('amountID' + dish.No).innerHTML,excption.cart[dish.No]);
				api.toast({
					msg : '成功刪減 ' + amount + ' 份 ' + dish.name,
					location : 'bottom',
					duration : 1000
				});
			}).catch(function(error) {
				api.hideProgress();
				errorAlert(error);
			});
		}
	</script>
</html>
