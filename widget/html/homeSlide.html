<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>Home</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/homeSlide.css" />
	</head>
	<body>
		<div class="header" id="header">
			<div class="left" onclick="sliding();" tapmode="itemhover"><img src="../image/deliver/man.png" alt="" />
			</div>
			<div class="center">
				<span>配送订单</span>
			</div>
			<!--<div class="right" tapmode="itemhover"><img src="../image/deliver/favorite.png" alt="" onclick="reloadList();"/>
			</div>-->
		</div>
		<!--<div class="topInTime" id="topInTime">
		<div class="calendar" >
		<span  onclick="calendarShow();" id="calendar"> <span id = 'year'></span>年<span id = 'month'></span>月<span id = 'day'></span>日<span id = 'week'></span> </span>
		&nbsp;&nbsp;&nbsp;&nbsp; <span class="searchBtn" onclick="searchOrder();">&nbsp;搜&nbsp;&nbsp;索&nbsp;</span>
		</div>
		</div>-->
		<div class="navbar activebar">
			<span id="navbar-item-waitForAcceptance" class="navbar-item navbar-item-active" tapmode="navbar-item-hover" onclick="changeOrderList(0);">待接单 <em id="num"   style="display:none;position: absolute;  background-color: red;width: 15px;height: 15px;border-radius: 20px;color: white;font-weight: bold;line-height: 15px;float: right;font-size: 10px;">0</em> </span>
			<span id="navbar-item-deliveringList" class="navbar-item" tapmode="navbar-item-hover" onclick="changeOrderList(1);">自己送</span>
			<span id="navbar-item-otherDeliveringList" class="navbar-item" tapmode="navbar-item-hover" onclick="changeOrderList(2);">他人送</span>
			<span id="navbar-item-receiptedList" class="navbar-item" tapmode="navbar-item-hover" onclick="changeOrderList(3);">已收货 </span>
			<span id="navbar-item-reject" class="navbar-item" style="padding-right: 10px;" tapmode="navbar-item-hover" onclick="changeOrderList(4);">拒退款 <em id="reNum" hidden style="display:none;position: absolute; background-color: red;width: 15px;height: 15px;border-radius: 20px;color: white;font-weight: bold;line-height: 15px;float: right;font-size: 10px;">0</em> </span>
			<mark id="navmark">
				<img src="../image/header_icon/quick_action_arrow_up.png">
			</mark>
		</div>
		<div id="main"></div>
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/homeSlide.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script type="text/javascript" src = "../script/wilddog.js" ></script>
	<script type="text/javascript" src = "../script/underscore-min.js" ></script>
	<script>
		var keybackNum = 0, timeObj;
		var open = false;
		var intID;
		apiready = function() {
			var header = $api.byId('header');
			$api.fixStatusBar(header);
			api.addEventListener({
				name : 'keyback'
			}, function(ret, err) {
				var advLs = $api.getStorage('adv');
				if (advLs) {
					api.execScript({
						//						name : 'orderList_simple',
						frameName : advLs,
						script : 'goBack();'
					});
				} else {
					if (keybackNum) {
						api.closeWidget({
							silent : true
						});
					} else {
						keybackNum += 1;
						api.toast({
							msg : '再按一次退出开饭吧送餐',
							duration : 2000,
							location : 'bottom'
						});
						setTimeout(function() {
							keybackNum = 0;
						}, 3000);
					}
				}
				$api.rmStorage('adv');
			});
			api.addEventListener({
				name : 'swiperight'
			}, function(ret, err) {
				api.openSlidPane({
					type : 'left'
				});
				open = true;
			});
			loadingOrderLists();
			getOrdersByType();
			getPsOrdersNum();
			//			alarmInit();
			//执行频率
			//			intID = window.setInterval(function() {
			//				getOrdersByType();
			//			}, 120000);
			//			api.execScript({
			//				name : 'orderList_simple',
			//				frameName : 'waitingList',
			//				script : 'getOrdersNum("' + ['等待接单', '申请退款'] + '", 0);'
			//			});
		}
		function sliding() {
			api.openSlidPane({
				type : 'left'
			});
		}

		function calendarInit(date) {
			console.log("进入calendarInit")
			timeObj = api.require('UICalendar');
			timeObj.open({
				rect : {
					x : 20,
					y : 110,
					w : 320,
					h : 220,
				},
				styles : {
					bg : 'rgba(20,20,20,500)',
					week : {
						weekdayColor : '#FFFFFF',
						weekendColor : '#a8d400',
						size : 12
					},
					date : {
						color : '#FFFFFF',
						selectedColor : '#fff',
						selectedBg : '#a8d500',
						size : 12
					},
					today : {
						color : 'rgb(230,46,37)',
						bg : ''
					},
					specialDate : {
						color : '#a8d500',
						bg : ''
					}
				},
				switchMode : 'vertical',
				fixedOn : '',
				fixed : true
			}, function(ret, err) {
				console.log(JSON.stringify(ret));
				var d = new Date();
				d.setFullYear(ret.year);
				d.setMonth(ret.month - 1);
				if (ret.eventType == 'special' || ret.eventType == 'normal') {
					//点击选择日期并隐藏日历
					d.setDate(ret.day);
					dateInit(d);
					timeObj.hide();
				} else if (ret.eventType == 'switch') {
					//上下滑动选择月份
					dateInit(d);
				} else if (ret.eventType == 'show') {
				}
			});
			timeObj.hide();
			dateInit(new Date());
		}

		function calendarShow() {
			timeObj.show();
		}

		function dateInit(date) {
			var weekday = ["星期天", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];
			document.getElementById("year").innerHTML = date.getFullYear();
			document.getElementById("month").innerHTML = date.getMonth() + 1;
			document.getElementById("day").innerHTML = date.getDate();
			document.getElementById("week").innerHTML = " " + weekday[date.getDay()];
		}

		function searchOrder() {
			var year = document.getElementById("year").innerHTML, month = document.getElementById("month").innerHTML, day = document.getElementById("day").innerHTML;
			api.execScript({
				name : 'homeSlide',
				frameName : 'waitingList',
				script : 'searchOrder(' + year + ',' + month + ',' + day + ');'
			});
		}

		function alarmInit() {
			var tmp = $api.getStorage('alarmOn');
			if (tmp) {
				$api.rmStorage('alarmOn');
			}
			$api.setStorage('alarmOn', 1);
			api.execScript({
				name : 'homeSlide',
				script : 'getOrdersByType();'
			});
		}

		function alarmStop() {
			var tmp = $api.getStorage('alarmOn');
			if (tmp) {
				$api.rmStorage('alarmOn');
			}
			$api.setStorage('alarmOn', 0);
			//清除定时器
			window.clearInterval(intID);
			console.log(false);
		}

		function updateManStatus() {
			//必须登录
			var queryMan = new AV.Query(DeliveryMan);
			queryMan.equalTo('owner', AV.User.current());
			queryMan.first().then(function(manObj) {
				manObj.save();
			}).catch(function(error) {
				console.log(JSON.stringify(error));
			});
		}

		function getPsOrdersNum() {
			var carId = $api.getStorage("cafecarId");
			var waitingArr = new Array();
			var ref = new Wilddog("https://kaifanba.wilddogio.com/deliveryOrderRef/" + carId);
			ref.limitToFirst(100).on("value", function(datasnapshot) {
//				console.log("datasnapshot>>>" + JSON.stringify(datasnapshot.val()))
				waitingArr = _.filter(datasnapshot.val(), function(val, key) {
					return val.status == "等待接单";
				});
				console.log("waitingArr>>>" + JSON.stringify(waitingArr))
				api.execScript({
					name : 'homeFixed',
					script : 'psNumShow(' + waitingArr.length + ')'
				});
			});
		}

		//获取申请退款的数目
		function getOrdersByType() {
			var carId = $api.getStorage("cafecarId");
			var uName = $api.getStorage("useName");
			$api.setStorage("page", 0);
			var relation, relationPrior;
			var waitingArr, deliverArr, otherDeliverArr, receiptedArr, rejectArr, rejectNum;
			var ref = new Wilddog("https://kaifanba.wilddogio.com/orderRef/" + carId);
			var proArray = new Array();
			ref.limitToFirst(100).on("value", function(datasnapshot) {
//				console.log("datasnapshot>>>" + JSON.stringify(datasnapshot.val()))
				var snap = _.groupBy(datasnapshot.val(), function(val) {
					val.deliverMark = val.deliverMark ? val.deliverMark : "0";
					return val.deliverMark;
				});
				var ordersByMark1 = _.sortBy(snap[1], function(val) {
					return val.presetTime ? new Date(val.presetTime).getTime() : new Date().getTime();
				});
				var ordersByMark0 = _.sortBy(snap[0], function(val) {
					return val.presetTime ? new Date(val.presetTime).getTime() : new Date().getTime();
				});
				var newOrderArr = ordersByMark1.concat(ordersByMark0);
				//合并
				waitingArr = _.filter(newOrderArr, function(val, key) {
					return val.status == "等待接单";
				});
				deliverArr = _.filter(newOrderArr, function(val, key) {
					//					console.log("val.deliveryMan111111111>>>" + val.deliveryMan + ">>>>uName>>>>" + uName)
					return val.status == "配送中" && val.deliveryMan == uName;
				});
				otherDeliverArr = _.filter(newOrderArr, function(val, key) {
					//					console.log("val.deliveryMan22222222>>>" + val.deliveryMan + ">>>>uName>>>>" + uName)
					return val.status == "配送中" && val.deliveryMan != uName;
				});
//				console.log("otherDeliverArr>>>" + JSON.stringify(otherDeliverArr))
				receiptedArr = _.filter(newOrderArr, function(val, key) {
					return val.status == "已收货";
				});
				rejectArr = _.filter(newOrderArr, function(val, key) {
					if (val.status == "申请退款") {
						val.priority = 1;
					}
					if (val.status == "同意退款") {
						val.priority = 2;
					}
					if (val.status == "已退款") {
						val.priority = 3;
					}
					if (val.status == "已拒单") {
						val.priority = 4;
					}
					return val.status == "申请退款" || val.status == "已退款" || val.status == "已拒单" || val.status == "同意退款";
				});
				rejectNum = _.filter(newOrderArr, function(val, key) {
					return val.status == "申请退款";
				});
				if (waitingArr.length > 0 || rejectNum.length > 0) {
					alertSound();
				}
				rejectArr = _.sortBy(rejectArr, function(val) {
					return val.priority;
				});
				//加载数据,一次加载5个窗体
				setTimeout(function() {
					api.execScript({
						name : 'homeSlide',
						frameName : 'waitingList',
						script : 'setStatus(' + JSON.stringify(waitingArr) + ');'
					});
					api.execScript({
						name : 'homeSlide',
						frameName : 'deliveringList',
						script : 'setStatus(' + JSON.stringify(deliverArr) + ');'
					});
					api.execScript({
						name : 'homeSlide',
						frameName : 'otherDeliveringList',
						script : 'setStatus(' + JSON.stringify(otherDeliverArr) + ');'
					});
					api.execScript({
						name : 'homeSlide',
						frameName : 'finishedList',
						script : 'setStatus(' + JSON.stringify(receiptedArr) + ');'
					});
					api.execScript({
						name : 'homeSlide',
						frameName : 'rejectList',
						script : 'setStatus(' + JSON.stringify(rejectArr) + ');'
					});
				}, 1000);
				numShow(waitingArr.length, rejectNum.length);
			});
		}

		function numShow(numW, numR) {
			//			console.log("numW>>>" + numW + ":numR>>>" + numR)
			if (numW == 0) {
				document.getElementById('num').style.display = "none";
			} else {
				document.getElementById('num').innerHTML = numW;
				document.getElementById('num').style.display = "";
			}
			if (numR == 0) {
				document.getElementById('reNum').style.display = "none";
			} else {
				document.getElementById('reNum').innerHTML = numR;
				document.getElementById('reNum').style.display = "";
			}
		}

		function getOverTimeOrder() {
			//必须登录
			var queryMan = new AV.Query(DeliveryMan);
			queryMan.equalTo('owner', AV.User.current());
			return queryMan.first().then(function(manObj) {
				if (manObj) {
					var query = new AV.Query(Order);
					query.include('customer');
					query.equalTo('deliveryMan', manObj);
					//					query.containedIn('status', ["配送中"]);
					query.containedIn('status', ["配送中"]);
					var myDate = new Date();
					myDate.setHours(0, 0, 0, 0);
					// 今日付款
					query.greaterThanOrEqualTo('paidTime', new Date(myDate));
					// 从最早付款单算
					query.ascending('paidTime');
					return query.first().then(function(order) {
						console.log("order:" + JSON.stringify(order))
						if (order) {
							var distance = new Date().getTime() - new Date(order.paidTime());
							if (distance > (10 * 60 * 1000)) {
								return AV.Promise.as(true);
							} else {
								return AV.Promise.as(false);
							}
						} else {
							return AV.Promise.as(false);
						}
					}).catch(function(error) {
						return AV.Promise.error(error);
					});
				} else if (!manObj) {
					api.toast({
						msg : '当前登录无效，请重新登录',
						location : 'middle',
						duration : 2000
					});
					AV.User.logOut();
					api.openWin({
						name : 'login',
						url : '../new_login.html',
						opaque : true, // 页面不透明
						bounces : false, // 不允许页面弹动
						reload : true,
						delay : 2000
					});
				}
			}).catch(function(error) {
				return AV.Promise.error(error);
			});
		}

		function alertSound() {
			api.startPlay({
				path : 'widget://res/finishOrder.mp3'
			}, function() {
			});
		}

		function reloadList() {
			api.execScript({
				name : 'orderList_simple',
				frameName : 'waitingList',
				script : 'reloadFrame();'
			});
		}
	</script>
</html>
