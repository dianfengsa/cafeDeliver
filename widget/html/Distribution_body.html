<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="format-detection" content="telephone=no"/>
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>简略订单列表</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/psReset.css" />
		<link rel="stylesheet" type="text/css" href="../css/psStyle.css" />
		<link rel="stylesheet" type="text/css" href="../css/orderList_simple.css" />
	</head>
	<body>
		<div class="tab_title">
			<ul class="tc clear">
				<li data-num="">
					待接单
				</li>
				<li>
					配送中
				</li>
				<li>
					已收货
				</li>
				<li>
					拒退款
				</li>
			</ul>
		</div>
		<div class="tab_content">
			<ul>
				<!-- 待接单 -->
				<li id="warttingOrder"></li>
				<!-- 配送中 -->
				<li id="deliverOrder"></li>
				<!-- 已收货 -->
				<li id="receiptedOrder"></li>
				<!-- 拒退款 -->
				<li id="rejectOrder"></li>
			</ul>
		</div>
		<script type="text/template" id="template_warttingOrder">
			{{?it && it.length>0 }}
			{{~it:value:index}}
			<dl>
			<dt class="customer_info" onclick="makePhoneCall('{{=value.customerPhone}}');">
			客户电话:{{=value.customerPhone}} <i class="fr"></i>
			</dt>
			<dd>
			送餐地址:<span class="red">{{=value.address}}</span>
			</dd>
			<dd>
			客户姓名:<span class="black">{{=value.customerName}}</span>
			</dd>
			<dd>
			下单时间:<span class="black">{{=value.deliveryTime}}</span>
			</dd>
			<dd>
			预达时间:<span class="black tdu">{{=value.deliveryTime}}</span>
			</dd>
			<dd>
			实收金额:<span class="red">{{=value.price}}元</span>
			</dd>
			<dd onclick="openDeliveryManSelector('{{=value.objectId}}');">
			状态:<span class="btn_blue">{{=value.status}}</span>
			</dd>
			<dt class="menu_info">
			商家信息<i class="fr"></i>
			</dt>
			<dd>商家名称:<span class="black">{{=value.kitchen.name}}</span> </dd>
			<dd>商家地址:<span class="black">{{=value.kitchen.addressDetail}}</span></dd>
			{{?value.kitchen.remittanceInfo}}
			{{?value.kitchen.remittanceInfo.type=="phone"}}
			<dd onclick="makePhoneCall('{{=value.kitchen.remittanceInfo.account}}');">商家电话:<span class="black">{{=value.kitchen.remittanceInfo.account}}</span></dd>
			{{??}}
			<dd>商家电话:<span class="black">暂无,请联系管理员</span></dd>
			{{?}}
			{{??}}
			<dd>商家电话:<span class="black">暂无,请联系管理员</span></dd>
			{{?}}
			</dl>
			{{~}}
			{{?}}
		</script>
		<script type="text/template" id="template_deliverOrder">
			{{?it && it.length>0 }}
			{{~it:value:index}}
			<dl>
			<dt class="customer_info">
			<dt class="customer_info" onclick="makePhoneCall('{{=value.customerPhone}}');">
			客户电话:{{=value.customerPhone}} <i class="fr"></i>
			</dt>
			<dd>
			送餐地址:<span class="red">{{=value.address}}</span>
			</dd>
			<dd>
			客户姓名:<span class="black">{{=value.customerName}}</span>
			</dd>
			{{?value.deliveryMan}}
			<dd>
			送餐员:<span class="black">{{=value.deliveryMan.name}}</span>
			</dd>
			{{??}}
			<dd>
			送餐员:<span class="black">信息有误</span>
			</dd>
			{{?}}
			<dd>
			下单时间:<span class="black">{{=value.deliveryTime}}</span>
			</dd>
			<dd>
			预达时间:<span class="black tdu">{{=value.deliveryTime}}</span>
			</dd>
			<dd>
			实收金额:<span class="red">{{=value.price}}元</span>
			</dd>
			<dd>
			状态:<span class="btn_black">{{=value.status}}</span>
			</dd>
			<dt class="menu_info">
			商家信息<i class="fr"></i>
			</dt>
			<dd>商家名称:<span class="black">{{=value.kitchen.name}}</span> </dd>
			<dd>商家地址:<span class="black">{{=value.kitchen.addressDetail}}</span></dd>
			{{?value.kitchen.remittanceInfo}}
			{{?value.kitchen.remittanceInfo.type=="phone"}}
			<dd onclick="makePhoneCall('{{=value.kitchen.remittanceInfo.account}}');">商家电话:<span class="black">{{=value.kitchen.remittanceInfo.account}}</span></dd>
			{{??}}
			<dd>商家电话:<span class="black">暂无,请联系管理员</span></dd>
			{{?}}
			{{??}}
			<dd>商家电话:<span class="black">暂无,请联系管理员</span></dd>
			{{?}}
			<dd class="tc">
			<button onclick="openDeliveryManSelector('{{=value.objectId}}');">
			重新派单
			</button>
			<button onclick="served('{{=value.objectId}}','{{=value.deliveryMan.objectId}}');">
			确认送达
			</button>
			</dd>
			</dl>
			{{~}}
			{{?}}
		</script>
		<script type="text/template" id="template_receiptedOrder">
			{{?it && it.length>0 }}
			{{~it:value:index}}
			<dl>
			<dt class="customer_info">
			<dt class="customer_info" onclick="makePhoneCall('{{=value.customerPhone}}');">
			客户电话:{{=value.customerPhone}} <i class="fr"></i>
			</dt>
			<dd>
			送餐地址:<span class="red">{{=value.address}}</span>
			</dd>
			<dd>
			客户姓名:<span class="black">{{=value.customerName}}</span>
			</dd>
			{{?value.deliveryMan}}
			<dd>
			送餐员:<span class="black">{{=value.deliveryMan.name}}</span>
			</dd>
			{{??}}
			<dd>
			送餐员:<span class="black">信息有误</span>
			</dd>
			{{?}}
			<dd>
			下单时间:<span class="black">{{=value.deliveryTime}}</span>
			</dd>
			<dd>
			预达时间:<span class="black tdu">{{=value.deliveryTime}}</span>
			</dd>
			<dd>
			实收金额:<span class="red">{{=value.price}}元</span>
			</dd>
			<dd>
			状态:<span class="btn_green">{{=value.status}}</span>
			</dd>
			<dd>
			送达时间:<span class="red">{{=value.realDeliveryTime}}</span>
			</dd>
			<dt class="menu_info">
			商家信息<i class="fr"></i>
			</dt>
			<dd>商家名称:<span class="black">{{=value.kitchen.name}}</span> </dd>
			<dd>商家地址:<span class="black">{{=value.kitchen.addressDetail}}</span></dd>
			{{?value.kitchen.remittanceInfo}}
			{{?value.kitchen.remittanceInfo.type=="phone"}}
			<dd onclick="makePhoneCall('{{=value.kitchen.remittanceInfo.account}}');">商家电话:<span class="black">{{=value.kitchen.remittanceInfo.account}}</span></dd>
			{{??}}
			<dd>商家电话:<span class="black">暂无,请联系管理员</span></dd>
			{{?}}
			{{??}}
			<dd>商家电话:<span class="black">暂无,请联系管理员</span></dd>
			{{?}}
			</dl>
			{{~}}
			{{?}}
		</script>
		<script type="text/template" id="template_rejectOrder">
			{{?it && it.length>0 }}
			{{~it:value:index}}
			<dl>
			<dt class="customer_info">
			<dt class="customer_info" onclick="makePhoneCall('{{=value.customerPhone}}');">
			客户电话:{{=value.customerPhone}} <i class="fr"></i>
			</dt>
			<dd>
			送餐地址:<span class="red">{{=value.address}}</span>
			</dd>
			<dd>
			客户姓名:<span class="black">{{=value.customerName}}</span>
			</dd>
			{{?value.deliveryMan}}
			<dd>
			送餐员:<span class="black">{{=value.deliveryMan.name}}</span>
			</dd>
			{{??}}
			<dd>
			送餐员:<span class="black">信息有误</span>
			</dd>
			{{?}}
			下单时间:<span class="black">{{=value.deliveryTime}}</span>
			</dd>
			<dd>
			预达时间:<span class="black tdu">{{=value.deliveryTime}}</span>
			</dd>
			<dd>
			实收金额:<span class="red">{{=value.price}}元</span>
			</dd>
			<dd>
			状态:<span class="btn_red">{{=value.status}}</span>
			</dd>
			<dt class="menu_info">
			商家信息<i class="fr"></i>
			</dt>
			<dd>商家名称:<span class="black">{{=value.kitchen.name}}</span> </dd>
			<dd>商家地址:<span class="black">{{=value.kitchen.addressDetail}}</span></dd>
			{{?value.kitchen.remittanceInfo}}
			{{?value.kitchen.remittanceInfo.type=="phone"}}
			<dd onclick="makePhoneCall('{{=value.kitchen.remittanceInfo.account}}');">商家电话:<span class="black">{{=value.kitchen.remittanceInfo.account}}</span></dd>
			{{??}}
			<dd>商家电话:<span class="black">暂无,请联系管理员</span></dd>
			{{?}}
			{{??}}
			<dd>商家电话:<span class="black">暂无,请联系管理员</span></dd>
			{{?}}
			</dl>
			{{~}}
			{{?}}
		</script>
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script type="text/javascript" src="../script/doT.min.js"></script>
	<script type="text/javascript" src="../script/date.format.js"></script>
	<script type="text/javascript" src="../script/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="../script/index.js"></script>
	<script type="text/javascript" src="../script/timeago.js"></script>
	<script type="text/javascript" src = "../script/wilddog.js" ></script>
	<script type="text/javascript" src = "../script/underscore-min.js" ></script>
	<script>
		apiready = function() {
			getDeliveryOrder();
		}
		//获取申请退款的数目
		function getDeliveryOrder() {
			var carId = $api.getStorage("cafecarId");
			var ref = new Wilddog("https://kaifanba.wilddogio.com/deliveryOrderRef/" + carId);
			var proArray = new Array();
			var waitingArr, deliverArr, receiptedArr, rejectArr;
			ref.limitToFirst(100).on("value", function(datasnapshot) {
				//状态为等待接单
				waitingArr = _.filter(datasnapshot.val(), function(val, key) {
					return val.status == "等待接单";
				});
				var templateWartting = document.getElementById('template_warttingOrder').innerHTML;
				document.getElementById('warttingOrder').innerHTML = doT.template( templateWartting )(waitingArr);
				//状态为配送中
				deliverArr = _.filter(datasnapshot.val(), function(val, key) {
					return val.status == "配送中";
				});
				var templateDeliver = document.getElementById('template_deliverOrder').innerHTML;
				document.getElementById('deliverOrder').innerHTML = doT.template( templateDeliver )(deliverArr);
				//状态为已收货
				receiptedArr = _.filter(datasnapshot.val(), function(val, key) {
					return val.status == "已收货";
				});
				var templateReceipte = document.getElementById('template_receiptedOrder').innerHTML;
				document.getElementById('receiptedOrder').innerHTML = doT.template( templateReceipte )(receiptedArr);
				//状态为已拒单
				rejectArr = _.filter(datasnapshot.val(), function(val, key) {
					return val.status == "已拒单";
				});
				var templateReject = document.getElementById('template_rejectOrder').innerHTML;
				document.getElementById('rejectOrder').innerHTML = doT.template( templateReject )(rejectArr);
			});
		}

		function openDeliveryManSelector(orderId, type) {
			$api.setStorage("adv", "manSelector");
			api.openFrame({
				name : 'manSelector',
				url : './manSelector_2.html',
				rect : {
					x : 'auto',
					y : 'auto',
					w : 'auto',
					h : 'auto'
				},
				pageParam : {
					type : type,
					orderId : orderId,
					orderType : 2
				},
				bounces : false,
				opaque : false,
				bgColor : 'rgba(0, 0, 0, 0.8)',
				reload : true
			});
		}

		function served(orderId, customerId) {
			api.confirm({
				title : '提示',
				msg : '是否确认快餐已送达',
				buttons : ['取消', '确定']
			}, function(ret, err) {
				if (ret.buttonIndex == 2) {
					api.showProgress({
						title : '提交数据中...',
						modal : true
					});
					var request = {
						id : orderId,
						man : customerId,
						status : 2
					};
					AV.Cloud.run("updateDeliveryOrderStatus", request).then(function(prior) {
						console.log("prior>>>" + JSON.stringify(prior))
						api.hideProgress();
						api.toast({
							msg : '确认成功',
							locaion : "middle"
						});
					}).catch(function(erroer) {
						console.log("erroer>>>" + JSON.stringify(erroer))
						api.toast({
							msg : '派单失败,请联系管理员',
							locaion : "middle"
						});
						api.hideProgress();
						errorAlert(error);
					});
				}
			});
		}

		function makePhoneCall(telNum) {
			api.call({
				type : 'tel_prompt',
				number : telNum
			});
		}
	</script>
</html>
