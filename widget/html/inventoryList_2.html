<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>货存列表</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/inventoryList.css" />
		<style>
			li {
				padding-top: 5px;
			}
		</style>
	</head>
	<body style="background-color:white;">
		<script type="text/template" id="template_dishItem">
			<div style="height: 80px;">
			{{ if(it && it.dishes.length>0){ }}
			{{ for(var i=0; i<it.dishes.length; i++){ }}
			<!--名称-->
			<div  class={{=i%2==0?'div_Css1':'div_Css_1'}}>
			<div>
			<div  class={{=i%2==0?'div_Css2':'div_Css2'}} >
			<ul>
			<li class={{=i%2==0?'div_liCss':'div_liCss'}}>
			商家名称:{{=it.dishes[i].kitchenName}}
			</li>
			<li>
			<em class={{=i%2==0?'div_liEm':'div_liEm'}}>菜式名称:</em><b class={{=i%2==0?'div_liB':'div_liB'}}>{{=it.dishes[i].name}}</b>
			</li>
			</ul>
			</div>
			<div onclick="clickChecked('{{=it.dishes[i].No}}')"  class="div_Css3">
			{{if(it.dishes[i].isSelected==1){}}
			<input type="checkbox" id="ck{{=it.dishes[i].No}}" name ="checkNum" onclick="clickChecked('{{=it.dishes[i].No}}')"  data-value="{{=it.dishes[i].No}}" checked="checked"  style="width: 50px;height:50px;" />
			{{ }else{ }}
			<input type="checkbox" id="ck{{=it.dishes[i].No}}" name ="checkNum" onclick="clickChecked('{{=it.dishes[i].No}}')" data-value="{{=it.dishes[i].No}}" style="width: 50px;height:50px;" />
			{{}}}
			</div>
			</div>
			</div>
			{{ } }}
			{{ } }}
			</div>
		</script>
		<div class="inventoryList" id="inventoryListDiv"></div>
		<div class="emptyInventory" id="emptyDiv" hidden>
			<img src="../image/empty_page_nothing.png" alt="" />
			<div class="emptyAlert" id="emptyAlertDiv">
				暂无货存
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script type="text/javascript" src="../script/doT.min.js"></script>
	<script type="text/javascript" src="../script/jquery-1.11.1.min.js"></script>
	<script>
		var inventoryCart = new Array();
		var noArray = new Array();
		var noCheckArray = new Array();
		apiready = function() {
			if (AV.User.current()) {
				api.showProgress({
					title : '货存列表获取中...',
					modal : true
				});
				loadingInventory().then(function() {
					api.hideProgress();
					btnInit();
				}).catch(function(error) {
					api.hideProgress();
					errorAlert(error);
				});
			} else {
				api.toast({
					msg : '当前登录无效，请重新登录',
					location : 'middle',
					duration : 2000
				});
				AV.User.logOut();
				api.openWin({
					name : 'login',
					url : '../new_login.html',
					opaque : true, // 页面不透明
					bounces : false, // 不允许页面弹动
					reload : true,
					delay : 2000
				});
			}
		}
		function loadingInventory() {
			console.log("调用loadingInventory")
			var queryMan = new AV.Query(DeliveryMan);
			queryMan.equalTo('owner', AV.User.current());
			queryMan.include("cafeCar");
			return queryMan.first().then(function(manObj) {
				if (manObj) {
					var carObj = manObj.cafeCar();
					console.log("carObj:" + JSON.stringify(carObj))
					$api.setStorage("getCarId", carObj.id);
					console.log("loadingInventory>>>getCarId" + $api.getStorage("getCarId"))
					return getDishes(carObj);
				} else {
					AV.Promise.error("没有找到送餐员");
				}
			}).catch(function(error) {
				console.error(JSON.stringify(error));
				//				return AV.Promise.error(error);
				api.toast({
					msg : JSON.stringify(error.message)
				});
				document.getElementById('template_dishItem').innerHTML = '';
				document.getElementById('emptyDiv').hidden = false;
			});
		}

		function getDishes(carObj) {
			return new AV.Promise(function(resolve, reject) {
				if (!carObj) {
					document.getElementById('inventoryListDiv').innerHTML = '';
					document.getElementById('emptyDiv').hidden = false;
					return resolve();
				} else if (carObj && !carObj.cart()) {
					document.getElementById('inventoryListDiv').innerHTML = '';
					document.getElementById('emptyDiv').hidden = false;
					return resolve();
				} else if (carObj && carObj.cart()) {
					document.getElementById('emptyDiv').hidden = true;
					var catalog = api.pageParam.catalog;
					var hoursType = api.pageParam.hoursType;
					var request = {
						"carId" : carObj.id,
						"catalog" : catalog,
						"officeHours" : hoursType
					};
					return AV.Cloud.run("getDeliverMenu", request).then(function(dishes) {
						inventoryCart = dishes;
						console.log("dishes" + JSON.stringify(dishes))
						//重写
						var total = 0, paid = 0, remain = 0, isSelected = false;
						for ( i = 0; i < dishes.length; i++) {
							//							if ($.inArray(dishes[i].No, carObj.get("fixmenu")) != -1) {
							//								dishes[i].isSelected = true;
							//							} else {
							//								dishes[i].isSelected = false;
							//								noCheckArray.push(dishes[i].No);
							//							}
							//应收
							total += parseFloat(dishes[i].price) * parseInt(dishes[i].tasksIn);
							if (dishes[i].hasOwnProperty('sold')) {
								//网上实收
								paid += parseFloat(dishes[i].price) * parseInt(dishes[i].sold);
							}
							//未收金额
							remain = total + paid;
						}
						var tmp = {
							type : api.pageParam.type,
							dishes : dishes,
							total : total,
							remain : remain,
							paid : paid
						}
						api.execScript({
							name : 'myInventory',
							script : 'loadMoney(' + tmp.total + ',' + tmp.paid + ',' + tmp.remain + ');'
						});
						insertOrderItem(tmp);
						return resolve();
					}).catch(function(error) {
						return reject(error);
					});
				}
			});
		}

		function btnInit() {
			if (api.pageParam.type == '现货出售' || api.pageParam.type == '配送损耗') {
				//				$(".dishNum").each(function(i) {
				//					var numID = this.id, numberCode = numID.substring(8, numID.length);
				//					var inventory = parseInt(this.innerHTML);
				//					//					if (inventory <= 0) {
				//					//						document.getElementById('plus' + numberCode).style.display = 'none';
				//					//						document.getElementById('plus_gray' + numberCode).style.display = 'block';
				//					//					}
				//					//允许当前操作
				//					document.getElementById('plus' + numberCode).style.display = 'block';
				//					document.getElementById('plus_gray' + numberCode).style.display = 'none';
				//					document.getElementById('sub' + numberCode).style.display = 'none';
				//					document.getElementById('sub_gray' + numberCode).style.display = 'block';
				//				});
			} else if (api.pageParam.type == '菜单管理') {
				console.log('inventoryCart>>> ' + JSON.stringify(inventoryCart));
				$(".dishNum").each(function(i) {
					var numID = this.id, numberCode = numID.substring(9, numID.length);
					var inventory = parseInt(this.innerHTML);
					document.getElementById('input' + inventoryCart[i].No).value = inventory;
					//不允许当前负数减操作
					if (inventory <= 0) {
						document.getElementById('sub' + numberCode).style.display = 'none';
						document.getElementById('sub_gray' + numberCode).style.display = 'block';
					}
				});
			}
		}

		function subAmount(id) {
			//input
			var amount = parseInt(document.getElementById('input' + id).value) - 1;
			//显示修改后
			var inventory2 = parseInt(document.getElementById('amountID' + id).innerHTML) - 1;
			//当前实际货存
			var inventory = parseInt(document.getElementById('amount2ID' + id).innerHTML);
			if (api.pageParam.type == '现货出售' || api.pageParam.type == '配送损耗') {
				//				if (amount <= 0) {
				//					document.getElementById('input' + id).value = 0;
				//					document.getElementById('amountID' + id).innerHTML = inventory - 0;
				//					document.getElementById('sub' + id).style.display = 'none';
				//					document.getElementById('sub_gray' + id).style.display = 'block';
				//				} else {
				//					document.getElementById('input' + id).value = amount;
				//					document.getElementById('amountID' + id).innerHTML = inventory - amount;
				//					document.getElementById('sub' + id).style.display = 'block';
				//					document.getElementById('sub_gray' + id).style.display = 'none';
				//				}
				//				//				允许负数减操作
				//				if (inventory2 <= 0) {
				//					document.getElementById('plus' + id).style.display = 'none';
				//					document.getElementById('plus_gray' + id).style.display = 'block';
				//				} else {
				//					document.getElementById('plus' + id).style.display = 'block';
				//					document.getElementById('plus_gray' + id).style.display = 'none';
				//				}
			} else if (api.pageParam.type == '菜单管理') {
				// 不允许负数减操作
				if (amount <= 0) {
					document.getElementById('input' + id).value = amount;
					document.getElementById('sub' + id).style.display = 'none';
					document.getElementById('sub_gray' + id).style.display = 'block';
				} else {
					document.getElementById('input' + id).value = amount;
					document.getElementById('sub' + id).style.display = 'block';
					document.getElementById('sub_gray' + id).style.display = 'none';
				}
			}
		}

		function plusAmount(id) {
			var amount = parseInt(document.getElementById('input' + id).value) + 1;
			var inventory2 = parseInt(document.getElementById('amountID' + id).innerHTML) - 1;
			var inventory = parseInt(document.getElementById('amount2ID' + id).innerHTML);
			if (api.pageParam.type == '现货出售' || api.pageParam.type == '配送损耗') {
				//				if (amount <= 0) {
				//					document.getElementById('sub' + id).style.display = 'none';
				//					document.getElementById('sub_gray' + id).style.display = 'block';
				//				} else {
				//					document.getElementById('sub' + id).style.display = 'block';
				//					document.getElementById('sub_gray' + id).style.display = 'none';
				//				}
				//				//允许负数加操作
				//				document.getElementById('input' + id).value = amount;
				//				document.getElementById('amountID' + id).innerHTML = inventory - amount;
				//				if (inventory2 <= 0) {
				//					document.getElementById('input' + id).value = inventory - 0;
				//					document.getElementById('amountID' + id).innerHTML = 0;
				//					document.getElementById('plus' + id).style.display = 'none';
				//					document.getElementById('plus_gray' + id).style.display = 'block';
				//				} else {
				//					document.getElementById('input' + id).value = amount;
				//					document.getElementById('amountID' + id).innerHTML = inventory - amount;
				//					document.getElementById('plus' + id).style.display = 'block';
				//					document.getElementById('plus_gray' + id).style.display = 'none';
				//				}
			} else if (api.pageParam.type == '菜单管理') {
				//允许负数加操作
				if (amount <= 0) {
					//					document.getElementById('input' + id).value = 0;
					document.getElementById('input' + id).value = amount;
					document.getElementById('sub' + id).style.display = 'none';
					document.getElementById('sub_gray' + id).style.display = 'block';
				} else {
					document.getElementById('input' + id).value = amount;
					document.getElementById('sub' + id).style.display = 'block';
					document.getElementById('sub_gray' + id).style.display = 'none';
				}
			}
		}

		function insertOrderItem(items) {
			if (items.dishes.length) {
				var template = document.getElementById('template_dishItem').innerHTML;
				document.getElementById('inventoryListDiv').innerHTML = doT.template( template )(items);
			} else {
				document.getElementById('template_dishItem').innerHTML = '';
				document.getElementById('emptyDiv').hidden = false;
			}
			api.parseTapmode();
		}

		function exceptionEnsure(type, officeHoursType, catalog) {
			var noMenu = $api.getStorage("manFixmenu");
			$("input[name=checkNum]").each(function() {
				if ($(this).is(':checked')) {
					var thisVal = $(this).attr("data-value");
					noArray.push(Number(thisVal))
				}
			});
			noArray.sort();
			console.log("noArray>>>" + noArray)
			//得出移除未选中的数组
			for (var i = 0; i < noCheckArray.length; i++) {
				if ($.inArray(noCheckArray[i], noMenu) != -1) {
					//如果没有选中,然后在manFixmenu存在,则移除掉么有选中的这个元素
					noMenu.splice($.inArray(noCheckArray[i], noMenu), 1);
				}
			}
			if (noArray.length > noMenu.length) {
				//得出选中,则不存在数据库中的数组元素
				for ( i = 0; i < noArray.length; i++) {
					if ($.inArray(noArray[i], noMenu) == -1) {
						noMenu.push(noArray[i]);
					}
				}
			} else {
				noMenu = noArray;
			}
			noMenu.sort();
			noArray = [];
			api.confirm({
				title : type,
				msg : '是否确定选中菜式进行' + type + '？',
				buttons : ['取消', '确定']
			}, function(ret, err) {
				if (ret.buttonIndex == 2) {
					var exceptionCart = getManageCart(noMenu), mark = false;
					//新减旧
					var distanceCart = new Object();
					console.log("inventoryCart>>>" + JSON.stringify(inventoryCart))
					console.log("exceptionCart>>>" + JSON.stringify(exceptionCart))
					for ( i = 0; i < inventoryCart.length; i++) {
						if (exceptionCart.hasOwnProperty(inventoryCart[i].No)) {
							//修改后货存不为0
							var difference = parseInt(exceptionCart[inventoryCart[i].No]) - parseInt(inventoryCart[i].remain);
							inventoryCart[i].remain = exceptionCart[inventoryCart[i].No];
							console.log("进来difference" + JSON.stringify(difference))
							//修改本地货存记录
							if (difference != 0) {
								distanceCart[inventoryCart[i].No] = difference;
							}
						} else {
							//修改后货存为0
							var difference = 0 - parseInt(inventoryCart[i].remain);
							console.log("difference" + difference)
							inventoryCart[i].remain = 0;
							//修改本地货存记录
							if (difference != 0) {
								distanceCart[inventoryCart[i].No] = difference;
							}
						}
					}
					//修改值distanceCart
					for (v in distanceCart) {
						document.getElementById('amount2ID' + v).innerHTML = parseInt(document.getElementById('amount2ID' + v).innerHTML) + distanceCart[v];
						mark = true;
					}
					if (mark) {
						exceptionCreate(distanceCart, type, officeHoursType, catalog, noMenu);
					} else {
						api.confirm({
							title : type,
							msg : '确认进行选中菜式的' + type + '？',
							buttons : ['取消', '确定']
						}, function(ret, err) {
							if (ret.buttonIndex == 2) {
								exceptionCreate(distanceCart, type, officeHoursType, catalog, noMenu);
							}
						});
					}
				}
			});
			noArray = [];
		}

		function exceptionCreate(exceptionCart, type, officeHoursType, catalog, noMenu) {
			btnInit();
			console.log('exceptionCart:  ' + JSON.stringify(exceptionCart));
			console.log('inventoryCart:  ' + JSON.stringify(inventoryCart));
			inventoryManage(exceptionCart, type, officeHoursType, catalog, noMenu).then(function(retObj) {
				//刷新货存状况
				loadingInventory().then(function() {
					btnInit();
				}).catch(function(error) {
					errorAlert(error);
				});
			}).catch(function(error) {
				//					api.hideProgress();
				errorAlert(error);
			});
		}

		//选中checkbox更改状态
		function clickChecked(id) {
			var getMenu = $api.getStorage("manFixmenu");
			id = Number(id);
			var user = AV.User.current();
			var catObj = new Object();
			var catalog = api.pageParam.catalog;
			var hoursType = api.pageParam.hoursType;
			var carId = $api.getStorage("getCarId");
			$("input[name=checkNum]").each(function() {
				var thisVal = $(this).attr("data-value");
				if ($(this).is(':checked')) {
					catObj[thisVal] = 1;
				} else {
					catObj[thisVal] = -1;
				}
			});
			var request = {
				catalog : catalog,
				officeHoursType : hoursType,
				cart : catObj,
				carId : carId
			};
			console.log("request:" + JSON.stringify(request))
			AV.Cloud.run("changeMenuStatus", request).then(function(ret) {
				api.toast({
					msg : '更改菜单成功！'
				});
			}).catch(function(error) {
				console.log("error:" + JSON.stringify(error))
				api.toast({
					msg : '更改菜单失败！'
				});
			});
		}

		function setFixMenu(getMenu) {
			if (AV.User.current()) {
				var queryMan = new AV.Query(DeliveryMan);
				queryMan.equalTo('owner', AV.User.current());
				queryMan.include("cafeCar");
				return queryMan.first().then(function(manObj) {
					//console.log("manObj:" + JSON.stringify(manObj))
					if (manObj) {
						var carObj = manObj.cafeCar();
						if (carObj) {
							carObj.set('fixmenu', getMenu);
							return carObj.save();
						} else {
							return AV.Promise.error("送餐员不在该区域");
						}
					} else {
						return AV.Promise.error("没有找到送餐员");
					}
				}).catch(function(error) {
					console.log(JSON.stringify(error));
					return AV.Promise.error(error);
				});
			}
		}

		function inventoryManage(cart, type, officeHoursType, catalog, noArray) {
			console.log(noArray)
			if (AV.User.current()) {
				var queryMan = new AV.Query(DeliveryMan);
				queryMan.equalTo('owner', AV.User.current());
				queryMan.include("cafeCar");
				return queryMan.first().then(function(manObj) {
					if (manObj) {
						var carObj = manObj.cafeCar();
						if (carObj) {
							var newObj = new Exception();
							newObj.set('cafeCar', carObj);
							newObj.set('deliveryMan', manObj);
							newObj.set('cart', cart);
							newObj.set('officeHoursType', officeHoursType);
							newObj.set('type', type);
							//							newObj.set('fixmenu', noArray);
							newObj.set('catalog', catalog);
							newObj.set('description', '调整货存--' + type + '--测试中');
							return AV.Promise.when(newObj.save(), carObj.set('fixmenu', noArray).save());
						} else {
							return AV.Promise.error("送餐员不在该区域");
						}
					} else {
						return AV.Promise.error("没有找到送餐员");
					}
				}).catch(function(error) {
					console.log(JSON.stringify(error));
					return AV.Promise.error(error);
				});
			}
		}

		function getManageCart(noMenu) {
			var manageCart = new Object();
			$("input").each(function(i) {
				//				console.log(this.id);
				var str = this.id, numberCode = str.substring(5, str.length);
				if (this.value != 0) {
					manageCart[numberCode] = parseInt(this.value);
				}
			});
			console.log('manageCart>>> ' + JSON.stringify(manageCart));
			return manageCart;
		}

		function goback() {
			api.closeWin({
			});
		}
	</script>
</html>
