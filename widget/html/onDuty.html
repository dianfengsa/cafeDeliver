<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>修改状态</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/onDuty.css" />
	</head>
	<body>
		<div class="topBack">
			<img class="bg" src="../image/bg_003.png" alt="" />
		</div>
		<div class="header" id="header">
			<div class="backIcon" onclick="goBack();"><img src="../image/deliver/icon_back.png" alt="" />
			</div>
			<div class="title">
				<span>配送员状态</span>
			</div>
		</div>
		<div class="topInfo">
			<div class="status" id="statusDiv">
				<span id="status">休</span>
			</div>
		</div>
		<div class="middleInfo">
			<div class="h10"></div>
			<div class="h1"></div>
			<div class="item">
				<div class="manStatus">
					<span>配送员状态</span>
				</div>
				<div class="btn" tapmode="" onclick="changeStatus();">
					<img src="../image/icon/on.png" id="statusBtn" alt="" />
				</div>
			</div>
			<div class="h1"></div>
			<div class="logOutBtn" onclick="logOut();">
				<span>退出登录</span>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script>
		apiready = function() {
			api.addEventListener({
				name : 'keyback'
			}, function(ret, err) {
				goBack();
			});
			updateDeliveryManInfo();
		}
		function updateDeliveryManInfo() {
			window.header = $api.byId('header');
			$api.fixStatusBar(header);
			var query = new AV.Query(DeliveryMan);
			query.equalTo('owner', AV.User.current());
			query.first().then(function(manInfo) {
				if (manInfo) {
					if (manInfo.status() == '休息') {
						document.getElementById('status').innerHTML = '休';
						document.getElementById('statusDiv').className = 'status';
						document.getElementById('statusBtn').src = '../image/icon/off.png';
					} else if (manInfo.status() == '在岗') {
						document.getElementById('status').innerHTML = '送';
						document.getElementById('statusDiv').className = 'status-active';
						document.getElementById('statusBtn').src = '../image/icon/on.png';
					}
				}
			}).catch(function(error) {
			});
		}

		function changeStatus() {
			var tmp = document.getElementById('status').innerHTML;
			if (tmp == '送') {
				var newStatus = '休息';
				api.confirm({
					title : '提示',
					msg : '进入休息状态将不能接收配送订单，是否确定休息',
					buttons : ['取消', '确定']
				}, function(ret, err) {
					if (ret.buttonIndex == 2) {
						api.execScript({
							name : 'homeSlide',
							script : 'alarmStop();'
						});
						updateManStatus(newStatus);
					}
				});
			} else if (tmp == '休') {
				var newStatus = '在岗';
				api.confirm({
					title : '提示',
					msg : '是否确定配送，进入在岗状态',
					buttons : ['取消', '确定']
				}, function(ret, err) {
					if (ret.buttonIndex == 2) {
						api.execScript({
							name : 'homeSlide',
							script : 'alarmInit();'
						});
						updateManStatus(newStatus);
					}
				});
			}
		}

		function updateManStatus(status) {
			api.showProgress({
				title : '状态更新中...',
				modal : true
			});
			var query = new AV.Query(DeliveryMan);
			query.equalTo('owner', AV.User.current());
			query.first().then(function(manObj) {
				if (manObj) {
					manObj.set('status', status);
					manObj.save().then(function(manObj) {
						updateDeliveryManInfo();
						updateHomeFixed();
						api.hideProgress();
					}).catch(function(error) {
						api.hideProgress();
						errorAlert(error);
					});
				} else if (!manObj) {
					api.hideProgress();
					api.toast({
						msg : '当前登录无效，请重新登录',
						location : 'middle',
						duration : 2000
					});
					AV.User.logOut();
					api.openWin({
						name : 'login',
						url : '../new_login.html',
						opaque : true, // 页面不透明
						bounces : false, // 不允许页面弹动
						reload : true,
						delay : 2000
					});
				}
			}).catch(function(error) {
				api.hideProgress();
				errorAlert(error);
			});
		}

		function logOut() {
			api.confirm({
				title : '提示',
				msg : '确定注销本账户？',
				buttons : ['取消', '确定']
			}, function(ret, err) {
				if (ret.buttonIndex == 2) {
					AV.User.logOut();
					var currentUser = AV.User.current();
					api.openWin({
						name : 'login',
						url : '../new_login.html',
						opaque : true, // 页面不透明
						bounces : false, // 不允许页面弹动
						reload : true,
						delay : 0
					});
				}
			});
		}

		function goBack() {
			api.closeWin({
			});
		}

		function updateHomeFixed() {
			api.execScript({
				name : 'homeFixed',
				script : 'updateDeliveryManInfo();'
			});
		}
	</script>
</html>