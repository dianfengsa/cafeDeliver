<!DOCTYPE HTML>
<html>
	<head>
		<meta name="content-type" content="text/html" charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="format-detection" content="telephone=no">
		<link href="../css/web_css.css" rel="stylesheet">
		<!--页面样式-->
		<link href="../css/reset.css" rel="stylesheet">
		<!--重置样式-->
		<link rel="stylesheet" href="../css/flex-layout.css">
		<link rel="stylesheet" href="../css/layout.css">
		<link rel="stylesheet" href="../css/index.css">
		<title>配送请求</title>
	</head>
	<body onload="loaded()" style="overflow: hidden">
		<div class="top">
			<header class="m-header flex-column flex-middle flex-item-24">
				<p class="header-text flex-item-24 flex-center">
					<i class="back"></i>配送请求<i class="refresh"></i>
				</p>
			</header>
			<nav class="nav-box flex-item-24 flex-around flex-column" >
				<div class="flex-item-8 nav-text active" id="nav-1">
					<span>待接单</span><i id="nav-new1" class="nav-new"></i>
				</div>
				<div class="flex-item-8 nav-text" id="nav-2">
					<span>配送中</span><i id="nav-new2" class="nav-new"></i>
				</div>
				<div class="flex-item-8 nav-text " id="nav-3">
					<span>已完成</span><!--<i id="nav-new3" class="nav-new"></i>-->
				</div>
			</nav>
		</div>
		<!--顶部导航栏!-->
		<div class="mask flex-item-24"></div>
		<!--弹窗事件的遮罩-->
		<div class="m-content flex-item-24 flex-column" id="m-content">
			<!--订单模版渲染区域-->
			<div class="list flex-item-24 flex-center flex-row" id="list-1">
				<div class="pullDown flex-item-24 flex-center">
					<div class="pullDown-refresh">
						<i class="pullDown-img"></i><span>刷新订单列表</span>
					</div>
				</div>
				<div class="m-container-1 flex-item-24 flex-row flex-center" id="waitingOrder">
					<div class="flex-item-24 flex-center notform " ></div>
				</div>
				<div class="m-container-2 flex-item-24 flex-row flex-center" id="deliverOrder" style="display: none" >
					<div class="flex-item-24 flex-center notform " ></div>
				</div>
				<div class="m-container-3 flex-item-24 flex-row flex-center" id="finishedOrder" style="display: none"  >
					<div class="flex-item-24 flex-center notform " ></div>
				</div>
				<div class="pullUp flex-item-24 flex-center">
					<div class="pullUp-refresh">
						<i class="pullUp-img"></i><span>加载更多订单</span>
					</div>
				</div>
			</div>
		</div>
		<!--等待接单-->
		<script type="text/template" charset="utf-8" id="waiting_template">
			{{?it&&it.length>0}}
			{{~it:value:index}}
			<div class="user-box flex-item-23 ">
			<div class="user-info-top flex-item-24 ">
			<div class="user-info-text">
			<p>
			客户电话：{{=value.customerPhone}}
			</p>
			</div>
			</div>
			<div class="user-info-body flex-row flex-item-24 flex-center">
			<div class="user-info-add  flex-row flex-item-24 flex-center">
			<ul class="user-info-add-text flex-item-23 flex-center">
			<li>
			<div class="clock"></div><span class="clock-text">{{=new Date().format(value.deliveryTime,"isTime",0)}} 前送达</span><span class="money"><i>&#165</i>{{=value.price}}</span>
			</li>
			<li>
			<div class="order-time"></div><span class="order-time-text">下单时间:{{=new Date().format(value.createdAt,"dateTime",0)}}</span>
			</li>
			<li class="clearfix">
			<div class="destination">
			</div><span class="add-destination">{{=value.kitchen.name}}—{{=value.kitchen.addressDetail}}</span>
			</li>
			<li class="clearfix">
			<div class="source">
			</div><span class="add-source">{{=value.address}}</span>
			</li>
			</ul>
			<ul class="user-info-other flex-item-23 flex-center">
			<li class="">
			</li>
			</ul>
			<span>
			<input type="button" value="立即接单" data-value="{{=value.objectId}}" id="immediatelyOrder" class="dispatch">
			</span>
			</div>
			</div>
			</div>
			{{~}}
			{{?}}
		</script>
		<!--进行中的订单-->
		<script type="text/template" charset="utf-8" id="deliver_template">
			{{?it&&it.length>0}}
			{{~it:value:index}}
			<div class="user-box flex-item-23 ">
			<div class="user-info-top flex-item-24 ">
			<div class="user-info-text">
			<p>
			客户电话：{{=value.customerPhone}}
			</p>
			</div>
			</div>
			<div class="user-info-body flex-row flex-item-24 flex-center">
			<div class="user-info-add  flex-row flex-item-24 flex-center">
			<ul class="user-info-add-text flex-item-23 flex-center">
			<li>
			<div class="clock"></div><span class="clock-text">{{=new Date().format(value.deliveryTime,"isTime",0)}} 前送达</span><span class="money"><i>&#165</i>{{=value.price}}</span>
			</li>
			<li>
			<div class="order-time"></div><span class="order-time-text">下单时间:{{=new Date().format(value.createdAt,"dateTime",0)}}</span>
			</li>
			<li class="clearfix">
			<div class="destination">
			</div><span class="add-destination">{{=value.kitchen.name}}—{{=value.kitchen.addressDetail}}</span>
			</li>
			<li class="clearfix">
			<div class="source">
			</div><span class="add-source">{{=value.address}}</span>
			</li>
			</ul>
			<ul class="user-info-other flex-item-23 flex-center">
			<li class="">
			</li>
			</ul>
			<div class="user-info-other-button flex-item-24 flex-column">
			<div id="orderOperation" class="flex-item-24 flex-between flex-column">
			<button class="dispatch2" data-value="{{=value.objectId}}" data-cust="{{=value.deliveryMan.objectId}}}}">
			重新派单
			</button>
			<button class="dispatch3" data-value="{{=value.objectId}}" data-cust="{{=value.deliveryMan.objectId}}">
			确认送达
			</button>
			</div>
			</div>
			</div>
			</div>
			</div>
			{{~}}
			{{?}}
		</script>
		<!--已完成的订单(已收货、已退款、已拒单)-->
		<script type="text/template" charset="utf-8" id="finished_template">
			{{?it&&it.length>0}}
			{{~it:value:index}}
			<div class="user-box flex-item-23 ">
			<div class="user-info-top flex-item-24 ">
			<div class="user-info-text">
			<p>
			客户电话：{{=value.customerPhone}}
			</p>
			</div>
			</div>
			<div class="user-info-body flex-row flex-item-24 flex-center">
			<div class="user-info-add  flex-row flex-item-24 flex-center">
			<ul class="user-info-add-text flex-item-23 flex-center">
			{{?value.status=="已收货"}}
			<li class="clearfix order-complete">
			<div class="complete-img"></div><span class="order-complete">{{=value.status}}</span>
			</li>
			{{??value.status=="已拒单"}}
			<li class="clearfix order-complete">
			<div class="cancel-img"></div><span class="order-refund">{{=value.status}}</span>
			</li>
			{{??}}
			<li class="clearfix order-complete">
			<div class="cancel-img"></div><span class="order-refund">{{=value.status}}</span>
			</li>
			{{?}}
			<li class="clearfix">
			<div class="destination"> 
			</div><span class="add-destination">{{=value.kitchen.name}}—{{=value.kitchen.addressDetail}}</span>
			</li>
			<li class="clearfix">
			<div class="source"> 
			</div><span class="add-source">{{=value.address}}</span>
			</li>
			</ul>
			<ul class="user-info-other flex-item-23 flex-center">
			<li class="">
			</li>
			</ul>
			</div>
			</div>
			</div>
			{{~}}
			{{?}}
		</script>
		<!--没有订单时显示的部分-->
		<script type="text/template" charset="utf-8" id="noneOrder_template">
			<div class="flex-item-24 flex-center notform flex-bottom" style="display: block"></div>
		</script>
		<!--底部固定栏-->
	</body>
	<script src="../newAppJs/jquery.min.js"></script>
	<script src="../newAppJs/jquery.touchSwipe.min.js"></script>
	<script src="../newAppJs/jquery.rotate.min.js"></script>
	<script src="../newAppJs/iscroll.js"></script>
	<script src="../newAppJs/date.format.js"></script>
	<script src="../newAppJs/api.js"></script>
	<script src="../newAppJs/av.js" ></script>
	<script src="../newAppJs/dbSearch.js" ></script>
	<script src="../newAppJs/doT.min.js"></script>
	<!--模版配置脚本-->
	<script src="../newAppJs/orderDelive.js"></script>
	<script src="../newAppJs/underscore-min.js"></script>
	<script src="../newAppJs/wilddog.js" ></script>
	<!--页面脚本-->
	<script src="../newAppJs/share.js"></script>
	<script>
		var pageParam;
		apiready = function() {
			pageParam = api.pageParam;
			var winHeight = api.winHeight;
			//获取屏幕高度
			var winWidth = api.winWidth;
			//加载底部栏
			api.openFrame({
				name : 'footer',
				url : '../newAppHtml/footer.html',
				rect : {
					x : 0,
					y : winHeight - 60,
					w : "auto",
					h : 60
				},
				opaque : true, // 页面不透明
				bounces : false, // 不允许页面弹动，ripple
				vScrollBarEnabled : false,
				slidBackEnabled : false,
				pageParam : pageParam,
				delay : 0
			});
			var waitingArr = [], deliverArr = [], finishedArr = [];
			waitingArr = $api.getStorage("requestWaiting");
			deliverArr = $api.getStorage("requestDeliver");
			finishedArr = $api.getStorage("requestFinished");
			console.log("配送请求》》waitingArr>>>" + JSON.stringify(waitingArr))
			console.log("配送请求》》deliverArr>>>>" + JSON.stringify(deliverArr))
			console.log("配送请求》》finishedArr>>>>" + JSON.stringify(finishedArr))
			if (waitingArr.length > 0) {
				$("#nav-new1").text(waitingArr.length)
				document.getElementById('nav-new1').style.display = "inline-block";
				//状态为等待接单
				var templateWartting = document.getElementById('waiting_template').innerHTML;
				document.getElementById('waitingOrder').innerHTML = doT.template( templateWartting )(waitingArr);
			}
			//状态配送中
			if (deliverArr.length > 0) {
				$("#nav-new2").text(deliverArr.length)
				document.getElementById('nav-new2').style.display = "inline-block";
				var templateDeliver = document.getElementById('deliver_template').innerHTML;
				document.getElementById('deliverOrder').innerHTML = doT.template( templateDeliver )(deliverArr);
			}
			//状态为已完成
			if (finishedArr.length > 0) {
				var templateFinished = document.getElementById('finished_template').innerHTML;
				document.getElementById('finishedOrder').innerHTML = doT.template( templateFinished )(finishedArr);
			}
			//数据加载完成后再获取实际高度初始化iscroll
			//获取高度后再初始化iscroll
			var waitingOrderH = $("#waitingOrder").height();
			var deliverOrderH = $("#deliverOrder").height();
			var finishedOrderH = $("#finishedOrder").height();
			console.log("waitingOrderH:" + waitingOrderH);
			console.log("deliverOrderH:" + deliverOrderH);
			console.log("finishedOrderH:" + finishedOrderH);
			myScroll.refresh();
			//外卖订单
			$(".footer-box").on("touchend", "#footer-1", function() {
				openOrderDelive(pageParam);
			});
			//配送请求
			$(".footer-box").on("touchend", "#footer-2", function() {
				openOrderRequest(pageParam);
			});
			//订单搜索
			$(".footer-box").on("touchend", "#footer-3", function() {
				openOrderSearch(pageParam);
			});
			//配送员信息
			$(".footer-box").on("touchend", "#footer-4", function() {
				openOrderDeliveInfo(pageParam);
			});
			//重新派单事件
			$("#deliverOrder").on("touchend", ".dispatch2", function() {
				var orderId = $(this).attr("data-value");
				api.openFrame({
					name : 'deliveSelect',
					url : './deliveSelect.html',
					rect : {
						x : 0,
						y : 60,
						w : winWidth - (winWidth * 0.42),
						h : winHeight * 0.7
					},
					pageParam : {
						"cefeCar" : pageParam.cafeCar,
						"orderId" : orderId,
						"orderType" : 2
					},
					bounces : false,
					bgColor : 'rgba(0,0,0,0)',
					vScrollBarEnabled : true,
					hScrollBarEnabled : true,
					animation : {
						type : "push", //动画类型（详见动画类型常量）
						subType : "from_top", //动画子类型（详见动画子类型常量）
						duration : 200 //动画过渡时间，默认300毫秒
					}
				});
			});
			//确认送达事件
			$("#deliverOrder").on("touchend", ".dispatch3", function() {
				var orderId = $(this).attr("data-value");
				var deliverId = $(this).attr("data-cust");
				served(orderId, deliverId);
			});
			console.log("pageParam>>>>>>>>" + JSON.stringify(pageParam))
			$("#list-1").on("click", ".dispatch", function() {
				var orderId = $(this).attr("data-value");
				api.openFrame({
					name : 'deliveSelect',
					url : './deliveSelect.html',
					rect : {
						x : 0,
						y : 60,
						w : winWidth - (winWidth * 0.4),
						h : "auto",
						marginLeft : 0, //相对父 window 左外边距的距离
						marginTop : 0, //相对父 window 上外边距的距离
						marginBottom : 0, //相对父 window 下外边距的距离
						marginRight : 0 //相对父 window 右外边距的距离
					},
					pageParam : {
						"cefeCar" : pageParam.cafeCar,
						"orderId" : orderId,
						"orderType" : 2
					},
					bounces : false,
					bgColor : 'rgba(0,0,0,0)',
					vScrollBarEnabled : true,
					hScrollBarEnabled : true,
					animation : {
						type : "push", //动画类型（详见动画类型常量）
						subType : "from_left", //动画子类型（详见动画子类型常量）
						duration : 200 //动画过渡时间，默认300毫秒
					}
				});
			});
		}
		function setRequestStatusNum() {
			var waitNum = $api.getStorage("requestWartNum");
			var deliverNum = $api.getStorage("requestDeliveNum");
			$("#nav-new1").text(waitNum)
			$("#nav-new2").text(deliverNum)
		}

		function loaded() {
			myScroll = new IScroll('#m-content', {
				probeType : 3,
				mouseWheel : true
			});
			var upIcon = $("#up-icon"), downIcon = $("#down-icon");
			myScroll.on("slideDown", function() {
				if (this.y > 20) {
					//刷新整个页面或者刷新订单数据
					console.log("刷新");
					//刷新完成后重新获取高度
					myScroll.refresh()
				}
			});
			myScroll.on("slideUp", function() {
				if (this.maxScrollY - this.y > 20) {
					//加载更多
					console.log("加载更多");
					//刷新完成后重新获取高度
					myScroll.refresh()
				}
			});
		}

		function served(orderId, customerId) {
			console.log("orderId>>>" + orderId)
			console.log("customerId>>>" + customerId)
			api.confirm({
				title : '提示',
				msg : '是否确认快餐已送达?',
				buttons : ['取消', '确定']
			}, function(ret, err) {
				if (ret.buttonIndex == 2) {
					api.showProgress({
						title : '提交数据中...',
						modal : true
					});
					var request = {
						id : orderId,
						man : customerId,
						status : 2
					};
					AV.Cloud.run("updateDeliveryOrderStatus", request).then(function(prior) {
						console.log("prior>>>" + JSON.stringify(prior))
						api.hideProgress();
						api.toast({
							msg : '确认成功',
							locaion : "middle"
						});
					}).catch(function(erroer) {
						console.log("erroer>>>" + JSON.stringify(erroer))
						api.toast({
							msg : '派单失败,请联系管理员',
							locaion : "middle"
						});
						api.hideProgress();
						errorAlert(error);
					});
				}
			});
		}
	</script>
