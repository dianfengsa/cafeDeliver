<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="format-detection" content="telephone=no"/>
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>简略订单列表</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/orderList_simple.css" />
	</head>
	<body>
		<script type="text/template" id="template_orderItem">
			{{ if(it && it.length>0){ }}
			{{ for(var i=0; i<it.length; i++){ }}
			<div class="divS1">
			<div  class="divS2">
			<span class="spanPhone" onclick="makePhoneCall('{{=it[i].mobile}}');"> 客户电话:{{=it[i].mobile}}
			<span style="float: right;padding-right: 20px;"><img style="width: 30px;padding-top: 5px;" src="../image/callPhone.png" />
			</span></span>
			<div style="background-color: #fbf7ef;padding-left: 10px;">
			<ul>
			{{?it[i].tsObject}}
			{{?it[i].tsObject.radioId==1||it[i].tsObject.radioId==2}}
			<li style="padding: 5px 0px 5px 0px;font-weight: bold;">
			<span style="font-size:18px;color:#808080;">点餐类型：</span><b style="color: red;font-size: 20px;">堂食点餐</b>
			</li>
			{{??}}
			<li style="padding: 5px 0px 5px 0px;font-weight: bold;">
			<span style="font-size:18px;color:#808080;">送餐地址：</span><b style="color: black;">{{=it[i].deliverAddress}}</b>
			</li>
			{{?}}
			{{??}}
			<li style="padding: 5px 0px 5px 0px;font-weight: bold;">
			<span style="font-size:18px;color:#808080;">送餐地址：</span><b style="color: black;">{{=it[i].deliverAddress}}</b>
			</li>
			{{?}}
			{{if(it[i].status=="等待接单"){}}
			<li style="padding: 5px 0px 5px 0px;font-weight: bold;" onclick="adviceSelect('{{=it[i].orderid}}','{{=it[i].kitchenId}}',{{!JSON.stringify(it[i].transPoints)}})">
			<span style="font-size:18px;color:#808080;">下车点：</span><b style="color: red;" id="zzDian">{{=it[i].adviceTransPoint}}</b>
			</li>
			{{}else{}}
			<li style="padding: 5px 0px 5px 0px;font-weight: bold;" >
			<span style="font-size:18px;color:#808080;">下车点：</span><b style="color: red;" id="zzDian">{{=it[i].adviceTransPoint}}</b>
			</li>
			<li style="line-height:25px;font-weight: bold;">
			<span style="color:#808080;">送餐类型：</span><b style="color: black;">{{=it[i].officeHoursType}}</b><em style="color: black;">(共:{{=it[i].totalAmount}}份)</em>
			</li>
			{{if(it[i].status=='配送中'||it[i].status=='已收货'){ }}
			<li style="line-height:25px;font-weight: bold;">
			<span style="color:#808080;">送餐人员：</span><b style="color: black;">{{=it[i].deliveryMan}}</b>
			</li>
			{{}}}
			{{}}}
			<li style="line-height:30px;font-weight: bold;">
			<span style="color:#808080;">下单时间：</span><b style="color: black;">{{=new Date().format(it[i].paidTime,"dateTime",0)}}</b>
			</li>
			<li style="line-height:30px;font-weight: bold;">
			{{ if(it[i].presetTime){ }}
			<span style="color:#808080;">预达时间：</span><b style="color: black;border-bottom: 1px solid black;"id="presetTime1{{=it[i].orderid}}">{{=new Date().format(it[i].presetTime,"dateTime",0)}}</b>
			{{ }else{ }}
			<span style="color:#808080;">预设时间：</span><b style="color: black;border-bottom: 1px solid black;" id="presetTime1{{=it[i].orderid}}">尽快送达</b>
			{{ }}}
			</li>
			<li style="line-height:20px;font-weight: bold;">
			<span style="color:#808080;">支付方式：</span>{{if(it[i].payType=="现金支付"){}} <b  style="color:red;">{{=it[i].payType}}</b> {{}else{}} <b style="color: black;">{{=it[i].payType}}</b> {{}}}
			</li>
			{{?it[i].tsObject}}
			<li style="line-height:30px;font-weight: bold;">
			{{?it[i].tsObject.radioId==1||it[i].tsObject.radioId==2}}
			<span style="color:#808080;">就餐编号：</span> <b  style="color:red;">{{=it[i].tsObject.txtEatNo}}</b>
			{{?}}
			<span style="color:#808080;">就餐方式：</span>
			{{?it[i].tsObject.radioId=="1"}}
			<b style="color:red;">到店就餐</b>
			{{?}}
			{{?it[i].tsObject.radioId=="2"}}
			<b style="color:red;">打包带走</b>
			{{?}}
			{{?it[i].tsObject.radioId=="3"}}
			<b style="color:red;">外卖点餐</b>
			{{?}}
			</li>
			{{??}}
			<li style="line-height:30px;font-weight: bold;">
			<span style="color:#808080;">就餐方式：</span>
			<b style="color:red;">外卖点餐</b>
			</li>
			{{?}}
			<li style="line-height:40px;font-weight: bold;">
			{{ if(it[i].deliverMark==0){ }}
			<span  style="color:#808080;" id="priorDiv{{=it[i].orderid}}" onclick="setPriorDisplay('{{=it[i].orderid}}');">标记优先：
			<span style="text-align: center;width: 40px;"><img  class="payStar" src="../image/deliver/start_gray.png" /></span>
			<em style="color: red;font-size: 12px;vertical-align: top;">(标记为星星,则表示排在前面)</em>
			</span>
			<span id="prioredDiv{{=it[i].orderid}}" onclick="cancelPriorDisplay('{{=it[i].orderid}}');"  style="display:none;color:#808080;">标记优先：
			<span style="text-align: center;width: 40px;"><img  class="payStar" src="../image/deliver/start_light.png" /></span>
			<em style="color: red;font-size: 12px;vertical-align: top;">(标记为星星,则表示排在前面)</em>
			</span>
			{{ }else if(it[i].deliverMark==1){ }}
			<span  id="priorDiv{{=it[i].orderid}}" onclick="setPriorDisplay('{{=it[i].orderid}}');" style="display:none;color:#808080;">标记优先：
			<span style="text-align: center;width: 40px;"><img  class="payStar" src="../image/deliver/start_gray.png" /></span>
			<em style="color: red;font-size: 12px;vertical-align: top;">(标记为星星,则表示排在前面)</em>
			</span>
			<span style="color:#808080;" id="prioredDiv{{=it[i].orderid}}" onclick="cancelPriorDisplay('{{=it[i].orderid}}');">标记优先：
			<span style="text-align: center;width: 40px;"><img  class="payStar" src="../image/deliver/start_light.png" /></span>
			<em style="color: red;font-size: 12px;vertical-align: top;">(标记为星星,则表示排在前面)</em>
			</span>
			{{ } }}
			</li>
			</ul>
			</div>
			{{if(it[i].description&&it[i].description.length>0){}}
			<div style="display: flex;padding-bottom: 5px;height: 30px;">
			<span style="background-color:red;width: 100%; ">
			<ul style="padding-left: 10px;">
			{{ for(var j=0; j<it[i].description.length; j++){ }}
			<li style="font: icon;font-weight: bold;color: white;line-height: 30px;">
			{{=it[i].description[j]}}
			</li>
			{{}}}
			</ul></span>
			</ul>
			</div>
			{{}}}
			<div onclick='slideDiv("divIDTasks{{=it[i].orderid}}",125,"{{=it[i].orderid}}")' id="divImgDown{{=it[i].orderid}}" style="height: 40px;background-color:#434343;"><em style="color: white;line-height: 40px;padding-left: 10px;font-weight: bold;">饭单信息</em>
			<span style="float: right;padding-right: 20px;"><img style="width: 30px;  padding-top: 5px;" src="../image/divdown.png" /></span>
			</div>
			<div onclick='slideDiv("divIDTasks{{=it[i].orderid}}",125,"{{=it[i].orderid}}")' id="divImgUp{{=it[i].orderid}}" style="height: 40px;background-color:#434343;display:none;"><em style="color: white;line-height: 40px;padding-left: 10px;font-weight: bold;">饭单信息</em>
			<span style="float: right;padding-right: 20px;"><img style="width: 30px;padding-top: 5px;" src="../image/divup.png" />
			</div>
			<div onclick='slideDiv("divIDTasks{{=it[i].orderid}}",125,"{{=it[i].orderid}}")' id="divIDTasks{{=it[i].orderid}}" style="height: 125px; overflow: hidden;border:1px dashed gray;">
			{{ if(it[i].tasks && it[i].tasks.length>0){ }}
			{{ for(var j=0; j<it[i].tasks.length; j++){ }}
			<div onclick='slideDiv("divIDTasks{{=it[i].orderid}}",136)' id="divIDTasks{{=it[i].orderid}}" style="overflow: hidden;">
			<ul class="ulstyle">
			<li class="liStyle1">
			商家名称:<b style="color: red;font-size: 16px;">{{=it[i].tasks[j].kitchenName}}</b><b class="liNo">编号:{{=it[i].tasks[j].number}}</b>
			</li>
			<li class="liAddr">
			商家地址:{{=it[i].tasks[j].address}}
			</li>
			<li class="liPhone">
			{{ if(it[i].tasks[j].restaurantPhone){ }}
			<span style="display: block;" onclick="makePhoneCall('{{=it[i].tasks[j].restaurantPhone}}');">
			商家电话:{{=it[i].tasks[j].restaurantPhone}}
			<em style=" float: right;padding-right: 10px;">状态:{{=it[i].tasks[j].status}}</em>
			</span>
			{{}else{}}
			<span style="display: block;">
			商家电话:暂无<em style=" float: right;padding-right: 10px;">状态:{{=it[i].tasks[j].status}}</em>
			</span>
			{{ } }}
			</li>
			<li style="padding-top: 10px;">
			<div class="liDivHead">
			<span class="spanListy">菜名</span><span class="spanListy">单价</span><span class="spanListy">数量</span>
			</div>
			{{ for(var k=0; k<it[i].tasks[j].cart.length; k++){ }}
			<div class="liDivS">
			<span class="spanCm">{{=it[i].tasks[j].cart[k].menuName}}</span><span id="{{=it[i].cart[k].carNo}}" class="spanPic">{{=changeTwoDecimal_f(it[i].tasks[j].cart[k].price)}}/元</span><span class="spanPic">X<em style="width:6px;"></em>{{=Math.abs(it[i].tasks[j].cart[k].amount)}}</span>
			<!--<span style="border: 1px solid red;">
			<img style="width: 30px;height: 20px;" src="../image/down.png" />
			</span>-->
			</div>
			{{ } }}
			</li>
			</ul>
			{{ } }}
			{{}else{}}
			<ul class="ulstyle">
			<li style="padding-top: 10px;">
			<div class="liDivHead">
			<span class="spanListy">菜名</span><span class="spanListy">单价</span><span class="spanListy">数量</span>
			</div>
			{{ if(it[i].cart && it[i].cart.length>0){ }}
			{{ for(var k=0; k<it[i].cart.length; k++){ }}
			<div class="liDivS">
			<span class="spanCm">{{=it[i].cart[k].menuName}}</span>
			<span id="{{=it[i].cart[k].carNo}}" class="spanPic">{{=changeTwoDecimal_f(it[i].cart[k].price)}} /元</span>
			<span class="spanPic">X<em style="width:6px;"></em>{{=Math.abs(it[i].cart[k].amount)}}</span>
			</div>
			{{ } }}
			{{ } }}
			</li>
			</ul>
			<span style="border: 1px solid red;">
			<img style="width: 30px;height: 20px;" src="../image/down.png" />
			</span>
			</div>
			{{ } }}
			</div>
			</div>
			<div class="divFooter">
			<span>支付金额：{{=changeTwoDecimal_f(it[i].totalPrice)}}元</span>
			<span class="spanStatus">状态：
			{{ if(it[i].status=='等待接单'){ }}
			<button type="button" class="spanBtn" onclick="openDeliveryManSelector('{{=it[i].orderid}}');">{{=it[i].status}}</button>
			{{ }else if(it[i].status=='已拒单'){ }}
			<!--<button type="button" class="spanBtn" style="background-color: red;" onclick="openDeliveryManSelector('{{=it[i].orderid}}');">{{=it[i].status}}</button>-->
			<button type="button" class="spanBtn" style="background-color: red;">{{=it[i].status}}</button>
			{{ }else if(it[i].status=='申请退款'){ }}
			<button type="button" class="spanBtn" onclick="isRejectRefund('{{=it[i].orderid}}');">{{=it[i].status}}</button>
			{{ }else if(it[i].status=='已收货'){ }}
			<button type="button" class="spanBtnReady">{{=it[i].status}}</button>
			{{ } else{}}
			<button type="button" style="background-color:#434343;" class="spanBtn">{{=it[i].status}}</button>
			{{ }}}
			</div>
			{{ if(it[i].status=='配送中'){ }}
			<div class="row">
			<div class="optBtn">
			<div style="width:50%;float:left;" onclick="served('{{=it[i].orderid}}', '{{=it[i].customerId}}');">
			<button disable="true" class="submit">
			确认送达
			</button>
			</div>
			<div style="width:50%;float:right;" onclick="openDeliveryManSelector('{{=it[i].orderid}}','1');">
			<button disable="true" class="submit">
			重新派单
			</button>
			</div>
			</div>
			</div>
			{{ } }}
			{{ if(it[i].status=='已收货'){ }}
			<div class="receiptTime">
			送达时间：<span>{{=new Date().format(it[i].receiptTime,"isoTime",0)}}</span>
			<span style="width:10px;"></span>
			配送员：<span >{{=it[i].deliveryMan}}</span>
			</div>
			{{ } }}
			<div class="divMark">
			订单备注:{{=it[i].mark}}
			</div>
			</div>
			<div style="height: 20px;background-color: gray;"></div>
			{{ } }}
			{{ } }}
		</script>
		<div class="orderList_simple" id="orderList_simpleDiv"></div>
		<!--<div class="orderList_simple" id="orderList_simpleDiv1"></div>-->
		<div class="emptyOrder" id="emptyDiv" >
			<img src="../image/noOrder.png" alt="" />
			<div class="emptyAlert" id="emptyAlertDiv"></div>
		</div>
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script type="text/javascript" src="../script/doT.min.js"></script>
	<script type="text/javascript" src="../script/date.format.js"></script>
	<script type="text/javascript" src="../script/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="../script/timeago.js"></script>
	<script>
		var catalogList = {
			"0" : "正餐",
			"1" : "超市",
			"2" : "甜品",
			"3" : "服务",
		};
		var carRetailPrice;
		var reloadFrameObj = {//需要刷新页面
			"waitingList" : 'getOrdersByType();',
			"rejectList" : 'getOrdersByType();'
		};
		var page = 1;
		var getSearchDate = new Date();
		var intID;
		apiready = function() {
			api.addEventListener({
				name : 'swipeleft'
			}, function(ret, err) {
				var frameIndex = $api.getStorage('frameIndex');
				var index = (frameIndex + 3) % 4;
				changeOrderList(index);
			});
			api.addEventListener({
				name : 'swiperight'
			}, function(ret, err) {
				var frameIndex = $api.getStorage('frameIndex');
				var index = (frameIndex + 1) % 4;
				changeOrderList(index);
			});
			//			api.setRefreshHeaderInfo({
			//				visible : true,
			//				bgColor : '#EFEFEF',
			//				textDown : '刷新配送订单..',
			//				textUp : '刷新配送订单..',
			//				textLoading : '数据加载中..'
			//			}, function(ret, err) {
			//				page = 1;
			//				$api.setStorage("page", page);
			//				document.getElementById('orderList_simpleDiv').innerHTML = '';
			//				loadDeliveringOrders().then(function() {
			//					api.refreshHeaderLoadDone();
			//					//					api.execScript({
			//					//						name : 'homeSlide',
			//					//						script : 'alarmInit();'
			//					//					});
			//				}).catch(function(error) {
			//					api.refreshHeaderLoadDone();
			//					errorAlert(error);
			//				});
			//			});
			if (AV.User.current()) {
				var carId = $api.getStorage("cafecarId");
				var proArray = new Array();
				///************************
				///野狗获取数据
				///************************
				if (carId) {
					//					api.showProgress({
					//						title : '订单列表获取中...',
					//						modal : false
					//					});
					//					var ref = new Wilddog("https://kaifanba.wilddogio.com/orderRef/" + carId);
					//					ref.on("value", function(datasnapshot) {
					//						console.log(" datasnapshot.val()>>>" + JSON.stringify(datasnapshot.val()))
					//						// 结果会在 console 中打印出 "beijing"
					//						for (var key in datasnapshot.val()) {
					//							console.log("datasnapshot.val()[key]>>>" + JSON.stringify(datasnapshot.val()[key]));
					//							proArray.push(datasnapshot.val()[key]);
					//						}
					//						if (proArray.length > 0) {
					//							document.getElementById('orderList_simpleDiv').innerHTML = "";
					//							document.getElementById('emptyDiv').hidden = true;
					//							var template = document.getElementById('template_orderItem').innerHTML;
					//							document.getElementById('orderList_simpleDiv').innerHTML = doT.template( template )(proArray);
					//						} else {
					//							document.getElementById('emptyDiv').hidden = flase;
					//						}
					//					});
					api.hideProgress();
				} else {
					api.hideProgress();
					api.toast({
						location : 'middle',
						duration : 3000,
						msg : '该用户暂未分配餐车'
					});
				}
				//				api.showProgress({
				//					title : '订单列表获取中...',
				//					modal : false
				//				});
				//				loadDeliveringOrders().then(function() {
				//					if (api.frameName == 'waitingList') {
				//						getOrdersNum(new Date(), ['等待接单', '申请退款'], 0, 1);
				//					}
				//					api.hideProgress();
				//				}).catch(function(error) {
				//					api.hideProgress();
				//					errorAlert(error);
				//				});
			} else {
				api.toast({
					msg : '当前登录无效，请重新登录',
					location : 'middle',
					duration : 2000
				});
				AV.User.logOut();
				api.openWin({
					name : 'login',
					url : '../new_login.html',
					opaque : true, // 页面不透明
					bounces : false, // 不允许页面弹动
					reload : true,
					delay : 2000
				});
			}
			//监听事件,是否下拉到底部
			//			api.addEventListener({
			//				name : 'scrolltobottom'
			//			}, function(ret, err) {
			//				api.showProgress({
			//					title : '上拉刷新数据...',
			//					modal : false
			//				}, 3000);
			//				var pages = $api.getStorage("page");
			//				if (pages) {
			//					page = Number(pages) + 1;
			//				} else {
			//					page = Number(page) + 1;
			//				}
			//				loadMoreMenu(page);
			//				$api.setStorage("page", page);
			//			});
		}
		function slideDiv(divID, height, id) {
			var obj = document.getElementById(divID).style;
			if (obj.height == "") {
				obj.height = height + "px";
				obj.overflow = "hidden";
				document.getElementById("divImgDown" + id).style.display = "block";
				document.getElementById("divImgUp" + id).style.display = "none";
			} else {
				obj.height = "";
				obj.overflow = "";
				document.getElementById("divImgDown" + id).style.display = "none";
				document.getElementById("divImgUp" + id).style.display = "block";
			}
		}

		function changeOrderList(index) {
			var tmp = $api.getStorage('frameIndex');
			if (tmp) {
				$api.rmStorage('frameIndex');
			}
			$api.setStorage('frameIndex', index);
			api.setFrameGroupIndex({
				name : 'order',
				index : index,
				sroll : true
			});
		}

		function unfoldDetail(id) {
			if (document.getElementById('cartDetailID' + id).hidden === true) {
				document.getElementById('arrowID' + id).src = '../image/deliver/arrowDown.png';
				document.getElementById('cartDetailID' + id).hidden = false;
			} else if (document.getElementById('cartDetailID' + id).hidden === false) {
				document.getElementById('arrowID' + id).src = '../image/deliver/arrowRight.png';
				document.getElementById('cartDetailID' + id).hidden = true;
			}
		}

		function loadDeliveringOrders() {
			var statusArr = {
				"0" : ['等待接单'],
				"1" : ['配送中'],
				"2" : ['配送中'],
				"3" : ['已收货'],
				"4" : ['申请退款', '已拒单', '同意退款']
			};
			var status = statusArr[api.pageParam.type];
			console.log("status>>>" + status)
			var queryMan = new AV.Query(DeliveryMan);
			queryMan.equalTo('owner', AV.User.current());
			return queryMan.first().then(function(manObj) {
				if (manObj && manObj.cafeCar()) {
					return getOrders(new Date(), status, 1, 1);
				} else if (manObj && !manObj.cafeCar()) {
					api.hideProgress();
					api.toast({
						msg : '当前用户尚未在该区域注册',
						location : 'middle',
						duration : 2000
					});
					document.getElementById('orderList_simpleDiv').innerHTML = '';
					document.getElementById('emptyAlertDiv').innerHTML = '当前用户尚未在该区域注册';
					document.getElementById('emptyDiv').hidden = false;
					return AV.Promise.as();
				} else if (!manObj) {
					api.hideProgress();
					api.toast({
						msg : '当前登录无效，请重新登录',
						location : 'middle',
						duration : 2000
					});
					AV.User.logOut();
					api.openWin({
						name : 'login',
						url : '../new_login.html',
						opaque : true, // 页面不透明
						bounces : false, // 不允许页面弹动
						reload : true,
						delay : 2000
					});
				}
			}).catch(function(error) {
				return AV.Promise.error(error);
			});
		}

		function getOrders(myDate, status, page, isSameDay) {
			api.showProgress({
				title : '订单列表获取中...',
				modal : false
			});
			//			var request = {
			//				type : api.pageParam.type,
			//				status : status,
			//				page : page
			//				//				inSameDay : isSameDay,
			//				//				orderDate : myDate.getTime()
			//			};
			//			var relation, relationPrior;
			//			console.log("getOrders>>>request>>>" + JSON.stringify(request))
			//			return AV.Cloud.run("getOrders", request).then(function(prior) {
			//				console.log("getOrders>>>prior>>>" + JSON.stringify(prior))
			//				if (!prior || prior.length == 0) {
			//					if (page !== 1) {
			//						api.toast({
			//							location : 'middle',
			//							msg : '没有更多数据了'
			//						});
			//					} else {
			//						document.getElementById('orderList_simpleDiv').innerHTML = '';
			//						document.getElementById('emptyAlertDiv').innerHTML = '';
			//						document.getElementById('emptyDiv').hidden = false;
			//					}
			//					api.hideProgress();
			//					return AV.Promise.as();
			//				} else {
			//					if (page == 1) {
			//						document.getElementById('emptyDiv').hidden = true;
			//						var template = document.getElementById('template_orderItem').innerHTML;
			//						document.getElementById('orderList_simpleDiv').innerHTML = doT.template( template )(prior);
			//						$api.setStorage("transPoints", prior[0].transPoints);
			//					} else {
			//						page = Number(page) + 1;
			//						var template1 = document.getElementById('template_orderItem').innerHTML;
			//						$("#orderList_simpleDiv").append("<div id='orderList_simpleDiv'+" + page + ">" + doT.template(template1)(prior) + "</div>");
			//					}
			//					api.hideProgress();
			//					return AV.Promise.as();
			//				}
			//				console.log("api.frameName<<<" + api.frameName + ">>>")
			//				if (api.frameName == "waitingList" || api.frameName == "rejectList") {
			//					getOrdersNum(myDate, ['等待接单', '申请退款'], page, isSameDay);
			//				}
			//			}).catch(function(error) {
			//				api.hideProgress();
			//				console.log(JSON.stringify(error));
			//			});
			api.execScript({
				name : 'homeSlide',
				script : 'getOrdersByType()'
			});
		}

		function getOrdersNum(myDate, status, page, isSameDay) {
			var wnum = 0, rnum = 0;
			isSameDay = isSameDay ? isSameDay : 0;
			var request = {
				status : status
				//				orderDate : myDate.getTime()
			}
			console.log("getOrdersNum>>>request>>>" + JSON.stringify(request))
			return AV.Cloud.run("getOrders", request).then(function(tasks) {
				if (tasks.length > 0) {
					for (var i = 0; i < tasks.length; i++) {
						if (tasks[i].status == "等待接单") {
							wnum += 1;
						} else if (tasks[i].status == "申请退款") {
							rnum += 1;
						}
					}
					if (wnum > 0 || rnum > 0) {
						//提示音
						alertSound();
					}
					api.execScript({
						name : "homeSlide",
						script : 'numShow(' + wnum + ',' + rnum + ');'
					});
					wnum = 0;
					rnum = 0;
					return AV.Promise.as();
				}
			}).catch(function(error) {
				console.error(JSON.stringify(error));
			});
		}

		// 建立排序辅助数组
		function createTimeArray(objs) {
			console.log("objs:" + JSON.stringify(objs))
			var timeArray = new Array();
			for ( i = 0; i < objs.length; i++) {
				if (objs[i].get("presetTime1")) {
					var lastTime = new Date().format(objs[i].get("presetTime1"), 'dateTime');
					var tmp = {
						No : i,
						time : lastTime,
						distance : new Date().getTime() - new Date(lastTime)
					}
					timeArray.push(tmp);
				} else if (objs[i].get("presetTime")) {
					var lastTime = new Date().format(objs[i].get("presetTime"), 'dateTime');
					var tmp = {
						No : i,
						time : lastTime,
						distance : new Date().getTime() - new Date(lastTime)
					}
					timeArray.push(tmp);
				} else {
					var paidTime = objs[i].get("paidTime"), lastTime = new Date().format(paidTime.getTime() + 15 * 60 * 1000, 'dateTime');
					var tmp = {
						No : i,
						time : lastTime,
						distance : new Date().getTime() - new Date(lastTime)
					}
					timeArray.push(tmp);
				}
			}
			return timeArray;
		}

		//排序1/2
		function timeSort1(arr, prop, desc) {
			var props = new Array(), ret = new Array(), len = arr.length;
			if ( typeof prop == 'string') {
				for (var i = 0; i < len; i++) {
					var oI = arr[i];
					(props[i] = new String(oI && oI[prop] || ''))._obj = oI;
				}
			} else if ( typeof prop == 'function') {
				for (var i = 0; i < len; i++) {
					var oI = arr[i];
					(props[i] = new String(oI && prop(oI) || ''))._obj = oI;
				}
			} else {
				throw '参数类型错误';
			}
			props.sort();
			for (var i = 0; i < len; i++) {
				ret[i] = props[i]._obj;
			}
			if (desc) {
				ret.reverse();
			}
			return ret;
		}

		function timeSort2(arr) {
			arr.sort(function compare(a, b) {
				return b.distance - a.distance
			});
			return arr;
		}

		function getOrderDetails(lastArray) {
			var orderDetails = new Array();
			var promise = AV.Promise.as();
			lastArray.forEach(function(item) {
				console.log("item+++++++" + JSON.stringify(item))
				promise = promise.then(function() {
					return getCartDetails(item).then(function(cartDetails) {
						var total = 0, money = 0;
						for ( i = 0; i < cartDetails.length; i++) {
							total += Math.abs(cartDetails[i].num);
							//							money += parseFloat(cartDetails[i].price) * Math.abs(cartDetails[i].num);
						}
						var orderInfo = {
							order : item.obj,
							reachTime : item.reachTime,
							cart : cartDetails,
							totalNum : total,
							//							money : money
						}
						orderDetails.push(orderInfo);
						return orderDetails;
					}).catch(function(error) {
						return AV.Promise.error(error);
					});
				});
			});
			return promise;
		}

		function insertOrderItem(items) {
			console.log("items:" + JSON.stringify(items))
			var template = document.getElementById('template_orderItem').innerHTML;
			document.getElementById('orderList_simpleDiv').innerHTML = doT.template( template )(items);
			getTimeago("abbr.timeago");
			retailPriceRefresh();
		}

		function retailPriceRefresh() {
			$('.numPrice').each(function(i) {
				//				console.log(JSON.stringify(carRetailPrice));
				if (carRetailPrice.hasOwnProperty(this.id)) {
					//					console.log('in');
					this.innerHTML = +changeTwoDecimal_f(carRetailPrice[this.id]) + " ";
				} else {
					//					console.log('out');
				}
			});
		}

		function getTimeago(elClass) {//转时间格式
			$(elClass).each(function(index) {
				var distance = new Date().getTime() - new Date(this.innerHTML);
				if (distance < 24 * 60 * 60 * 1000) {//小于24小时显示timeago
					$(this).timeago();
					if (distance >= 30 * 60 * 1000) {
						$(this).parents('.time').attr('class', 'timeWarn');
						$(this).parents('.topInfo').find('.status-active').attr('class', 'statusWarn');
					}
				} else {
					return false;
				}
			});
		}

		function makePhoneCall(telNum) {
			api.call({
				type : 'tel_prompt',
				number : telNum
			});
		}

		function displayQRCode(orderId, custId) {
			api.openFrame({
				name : 'qrCode',
				url : '../html/displayQRCode.html',
				rect : {
					x : 'auto',
					y : 'auto',
					w : 'auto',
					h : 'auto'
				},
				pageParam : {
					orderId : orderId,
					custId : custId
				},
				bounces : false,
				opaque : false,
				bgColor : 'rgba(0, 0, 0, 0.8)',
				reload : true
			});
		}

		function openDeliveryManSelector(orderId, type) {
			$api.setStorage("adv", "manSelector");
			cancelPriorDisplay(orderId);
			api.openFrame({
				name : 'manSelector',
				url : './manSelector_2.html',
				rect : {
					x : 'auto',
					y : 'auto',
					w : 'auto',
					h : 'auto'
				},
				pageParam : {
					type : type,
					orderId : orderId,
					orderType : 1
				},
				bounces : false,
				opaque : false,
				bgColor : 'rgba(0, 0, 0, 0.8)',
				reload : true
			});
		}

		function adviceSelect(orderId, kitchenId, transPoints) {
			$api.setStorage("adv", "adviceSelect");
			api.openFrame({
				name : 'adviceSelect',
				url : './adviceSelect.html',
				rect : {
					x : 'auto',
					y : 'auto',
					w : 'auto',
					h : 'auto'
				},
				pageParam : {
					orderId : orderId,
					kitchenId : kitchenId,
					transPoints : transPoints
				},
				bounces : false,
				opaque : false,
				bgColor : 'rgba(0, 0, 0, 0.8)',
				reload : true
			});
		}

		function setStatus(proArray) { 
			document.getElementById('emptyDiv').hidden = true;
			var template = document.getElementById('template_orderItem').innerHTML;
			document.getElementById('orderList_simpleDiv').innerHTML = doT.template( template )(proArray);
			if (!proArray.length) {
				document.getElementById('emptyDiv').hidden = false;
			}
		}

		function served(orderId, customerId) {
			api.confirm({
				title : '提示',
				msg : '是否确认快餐已送达',
				buttons : ['取消', '确定']
			}, function(ret, err) {
				if (ret.buttonIndex == 2) {
					api.showProgress({
						title : '提交数据中...',
						modal : true
					});
					AV.Cloud.run('receiptTemp', {
						"orderId" : orderId,
						"userId" : customerId
					}, {
						success : function(orderSuccess) {
							api.hideProgress();
							reloadFrame();
						},
						error : function(error) {
							console.log("error：" + JSON.stringify(error));
							var msg = error.hasOwnProperty("msg") ? error.msg : JSON.stringify(error);
							api.hideProgress();
							api.alert({
								title : '提示',
								msg : msg
							});
						}
					});
				}
			});
		}

		function alertSound() {
			api.startPlay({
				path : 'widget://res/finishOrder.mp3'
			}, function() {
			});
		}

		function reloadFrame() {
			//			loadDeliveringOrders().then(function() {
			//				if (api.frameName == "waitingList") {
			//					console.log(1)
			//					getOrdersNum(new Date(), ['等待接单', '申请退款'], 0, 1);
			//				}
			//			}).catch(function(error) {
			//				errorAlert(error);
			//			});
			api.execScript({
				name : 'homeSlide',
				script : 'getOrdersByType();'
			});
		}

		function setPriorDisplay(objectId) {
			console.log("setPriorDisplay:" + objectId);
			var query = new AV.Query(Order);
			query.get(objectId).then(function(obj) {
				obj.set('deliverMark', 1);
				return obj.save();
			}).then(function(ret) {
				if (ret.deliverMark() == 1) {
					document.getElementById('priorDiv' + objectId).style.display = "none";
					document.getElementById('prioredDiv' + objectId).style.display = "block";
				}
				//				loadDeliveringOrders().then(function() {
				//					api.refreshHeaderLoadDone();
				//				})
			}).catch(function(err) {
				console.log(JSON.stringify(err));
			});
		}

		function cancelPriorDisplay(objectId) {
			var query = new AV.Query(Order);
			query.get(objectId).then(function(obj) {
				obj.set('deliverMark', 0);
				return obj.save();
			}).then(function(ret) {
				if (ret.deliverMark() == 0) {
					console.log("cancelPriorDisplay:" + objectId);
					document.getElementById('priorDiv' + objectId).style.display = "block";
					document.getElementById('prioredDiv' + objectId).style.display = "none";
				}
				//				loadDeliveringOrders().then(function() {
				//					api.refreshHeaderLoadDone();
				//				})
			}).catch(function(err) {
				errorAlert("无效的订单号码");
				console.log(JSON.stringify(err));
			});
		}

		function setPresetTime1(objectId) {
			var time = new Date().getTime;
			api.openPicker({
				type : 'time',
				date : time,
				title : '选择预达时间'
			}, function(ret, err) {
				var tmpTime = new Date();
				tmpTime.setHours(ret.hour);
				tmpTime.setMinutes(ret.minute);
				api.confirm({
					title : '设置预达时间',
					msg : '是否设置预达时间为: ',
					buttons : ['确定', '清空预达时间', '取消']
				}, function(ret, err) {
					if (ret.buttonIndex == 1) {
						updatePresetTime1(objectId, tmpTime);
					} else if (ret.buttonIndex == 2) {
						updatePresetTime1(objectId, '');
					}
				});
			});
		}

		function updatePresetTime1(objectId, tmpTime) {
			var query = new AV.Query(Order);
			query.get(objectId).then(function(obj) {
				if (tmpTime == '') {
					obj.unset('presetTime1');
					return obj.save();
				} else {
					obj.set('presetTime1', tmpTime);
					return obj.save();
				}
			}).then(function(ret) {
				if (ret.presetTime1()) {
					document.getElementById('presetTime1' + objectId).innerHTML = new Date().format(ret.presetTime1(), "dateTime", 0);
				} else {
					document.getElementById('presetTime1' + objectId).innerHTML = '暂无';
				}
			}).catch(function(err) {
				console.log(JSON.stringify(err));
			});
		}

		function isRejectRefund(orderId) {
			api.confirm({
				title : '提示',
				msg : '是否同意退款?',
				buttons : ['同意', '不同意', '取消']
			}, function(ret, err) {
				if (ret.buttonIndex == 1) {
					console.log("同意退款");
					api.showProgress({
						title : '提交数据中...',
						modal : true
					});
					AV.Cloud.run('updateOrderRefund', {
						"orderId" : orderId,
						"status" : "同意退款"
					}, {
						success : function(orderSuccess) {
							api.hideProgress();
							reloadFrame();
						},
						error : function(error) {
							console.log("error：" + JSON.stringify(error));
							var msg = error.hasOwnProperty("msg") ? error.msg : JSON.stringify(error);
							api.hideProgress();
							api.alert({
								title : '提示',
								msg : msg
							});
						}
					});
				} else if (ret.buttonIndex == 2) {
					console.log("不同意退款");
					api.showProgress({
						title : '提交数据中...',
						modal : true
					});
					AV.Cloud.run('updateOrderRefund', {
						"orderId" : orderId,
						"status" : "等待接单"
					}, {
						success : function(orderSuccess) {
							api.hideProgress();
							reloadFrame();
						},
						error : function(error) {
							console.log("error：" + JSON.stringify(error));
							var msg = error.hasOwnProperty("msg") ? error.msg : JSON.stringify(error);
							api.hideProgress();
							api.alert({
								title : '提示',
								msg : msg
							});
						}
					});
				}
			});
		}

		function loadMoreMenu(page) {
			var sDate = getSearchDate;
			var statusArr = {
				"0" : ['等待接单'],
				"1" : ['配送中'],
				"2" : ['配送中'],
				"3" : ['已收货'],
				"4" : ['申请退款', '已拒单', '同意退款']
			};
			var status = statusArr[api.pageParam.type];
			getOrders(new Date(), status, page);
			api.hideProgress();
		}

		function searchOrder(year, month, day) {
			page = 1;
			api.showProgress({
				title : '订单列表获取中...',
				modal : false
			});
			var statusArr = {
				"0" : ['等待接单'],
				"1" : ['配送中'],
				"2" : ['配送中'],
				"3" : ['已收货'],
				"4" : ['申请退款', '已拒单', '同意退款']
			};
			var status = statusArr[api.pageParam.type];
			var searchDate = new Date();
			searchDate.setFullYear(year);
			searchDate.setMonth(parseInt(month) - 1);
			searchDate.setDate(day);
			getSearchDate = searchDate;
			$api.rmStorage("searchDate");
			$api.setStorage("searchDate", searchDate);
			getOrders(searchDate, status, 1).then(function(ret) {
				api.hideProgress();
			}).catch(function(error) {
				console.log(JSON.stringify(error))
				api.hideProgress();
				errorAlert(error);
			});
		}

		function compareDate(time1, time2) {
			if (time1 && time2) {
				var dt1 = new Date(time1).getFullYear() + '-' + (new Date(time1).getMonth() + 1) + '-' + new Date(time1).getDate();
				var dt2 = new Date(time2).getFullYear() + '-' + (new Date(time2).getMonth() + 1) + '-' + new Date(time2).getDate();
				if (dt1 == dt2) {//比较日期
					return true;
				} else {
					return false;
				}
			}
		}
	</script>
</html>
