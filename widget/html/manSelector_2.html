<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>配送员选择</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/manSelector.css">
	</head>
	<body>
		<div class="selector">
			<ul id="manItems">
				<div class="onDutyMenList" id="onDutyMenListDiv" ></div>
				<div class="emptyInventory" id="emptyDiv" hidden>
					<img src="../image/empty_page_nothing.png" alt="" />
					<div class="emptyAlert" id="emptyAlertDiv">
						暂无配送员
					</div>
				</div>
			</ul>
			<div class="btns">
				<div class="rejectBtn" id="rejectBtn" tapmode="pressRejectBtn" onclick="rejectOrderOrNot();">
					<span>拒 单</span>
				</div>
				<div class="goBackBtn" id="goBackBtn" tapmode="pressGoBackBtn" onclick="goBack();">
					<span>返 回</span>
				</div>
				<!--<div class="goBackBtn" id="goBackBtn1" style="margin-left: 30%;" tapmode="pressGoBackBtn" onclick="goBack();" hidden>
				<span>返 回</span>
				</div>-->
			</div>
		</div>
		<script type="text/template" charset="utf-8" id="template_selector">
			{{ if(it && it.length>0){ }}
			{{ for(var i=0; i<it.length; i++){ }}
			<li>
			<div class="item" tapmode="presshover" onclick="ensure('{{=it[i].objectId()}}', '{{=it[i].name()}}', '{{=it[i].area()}}');">
			<span>{{=it[i].name()}}</span>
			<span>|{{=it[i].area()}}<span>
			</div>
			</li>
			{{ } }}
			{{ } }}
		</script>
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/doT.min.js"></script>
	<!--<script type="text/javascript" src="../script/ajpush.js"></script>-->
	<script type="text/javascript" src="../script/common.js"></script>
	<script type="text/javascript" src="../script/underscore-min.js"></script>
	<script>
		var listViewObj, uiListViewObj;
		apiready = function() {
			listViewObj = api.require('listView');
			uiListViewObj = api.require('listView');
			var header = $api.byId('manItems');
			$api.fixStatusBar(header);
			if (AV.User.current()) {
				api.showProgress({
					title : '在岗配送员列表获取中...',
					modal : false
				});
				if (api.pageParam.orderType == 1) {
					loadingDeliveryMen().then(function() {
						api.hideProgress();
					}).catch(function(error) {
						api.hideProgress();
						errorAlert(error);
					});
				} else {
					loadingDeliveryMen2().then(function() {
						api.hideProgress();
					}).catch(function(error) {
						api.hideProgress();
						errorAlert(error);
					});
				}
			} else {
				api.toast({
					msg : '当前登录无效，请重新登录',
					location : 'middle',
					duration : 2000
				});
				AV.User.logOut();
				api.openWin({
					name : 'login',
					url : '../new_login.html',
					opaque : true, // 页面不透明
					bounces : false, // 不允许页面弹动
					reload : true,
					delay : 2000
				});
			}
		}
		function loadingDeliveryMen() {
			var query = new AV.Query(DeliveryMan);
			var queryOrder = new AV.Query(Order);
			query.include('cafeCar');
			query.exists('cafeCar');
			query.equalTo('owner', AV.User.current());
			queryOrder.include("deliveryMan");
			return AV.Promise.when(query.first(), queryOrder.get(api.pageParam.orderId)).then(function(manObj, order) {
				if (!_.isEmpty(manObj)) {
					console.log("getDeliveryMen>>>>>>0" + JSON.stringify(manObj))
					return getDeliveryMen(manObj.cafeCar(), order);
				} else if (!carObj) {
					api.hideProgress();
					api.toast({
						msg : '当前登录无效，请重新登录',
						location : 'middle',
						duration : 2000
					});
					AV.User.logOut();
					api.openWin({
						name : 'login',
						url : '../new_login.html',
						opaque : true, // 页面不透明
						bounces : false, // 不允许页面弹动
						reload : true,
						delay : 2000
					});
				}
			}).catch(function(error) {
				return AV.Promise.error(error);
			});
		}

		function loadingDeliveryMen2() {
			var query = new AV.Query(DeliveryMan);
			var queryOrder = new AV.Query(deliveryOrder);
			query.include('cafeCar');
			query.exists('cafeCar');
			query.equalTo('owner', AV.User.current());
			queryOrder.include("deliveryMan");
			return AV.Promise.when(query.first(), queryOrder.get(api.pageParam.orderId)).then(function(manObj, order) {
				if (!_.isEmpty(manObj)) {
					return getDeliveryMen(manObj.cafeCar(), order);
				} else if (!carObj) {
					api.hideProgress();
					api.toast({
						msg : '当前登录无效，请重新登录',
						location : 'middle',
						duration : 2000
					});
					AV.User.logOut();
					api.openWin({
						name : 'login',
						url : '../new_login.html',
						opaque : true, // 页面不透明
						bounces : false, // 不允许页面弹动
						reload : true,
						delay : 2000
					});
				}
			}).catch(function(error) {
				return AV.Promise.error(error);
			});
		}

		function getDeliveryMen(carObj, order) {
			var query;
			console.log("api.pageParam.type:" + api.pageParam.type);
			if (api.pageParam.type) {
				console.log(JSON.stringify(order.deliveryMan()));
				//				document.getElementById("rejectBtn").hidden = true;
				//				document.getElementById("goBackBtn").hidden = true;
				//				document.getElementById("goBackBtn1").hidden = false;
				query = carObj.deliveryManRelation().query().notEqualTo("objectId", order.deliveryMan().id);
			} else {
				//				document.getElementById("rejectBtn").hidden = false;
				//				document.getElementById("goBackBtn").hidden = false;
				//				document.getElementById("goBackBtn1").hidden = true;
				query = carObj.deliveryManRelation().query();
			}
			//			query.equalTo('status', '在岗');
			return query.find().then(function(results) {
				if (results.length == 0) {
					document.getElementById('onDutyMenListDiv').innerHTML = '';
					document.getElementById('emptyDiv').hidden = false;
					return AV.Promise.as();
				} else if (results.length > 0) {
					document.getElementById('emptyDiv').hidden = true;
					insertOrderItem(results);
					return AV.Promise.as();
				}
			}).catch(function(error) {
				return AV.Promise.error(error);
			});
		}

		//		function insertOrderItem(items) {
		//			var template = document.getElementById('template_selector').innerHTML;
		//			document.getElementById('onDutyMenListDiv').innerHTML = doT.template( template )(items);
		//			api.parseTapmode();
		//		}
		function insertOrderItem(items) {
			console.log(JSON.stringify(items));
			var data = new Array();
			items.forEach(function(time) {
				data.push({
					title : time.name(),
					subTitle : time.area(),
					//					titleLocation : 'center',
					titleSize : 20,
					//					subTitleLocation : 'center',
					subTitleSize : 16
				});
			});
			intiTimeSelect(data, items);
		}

		function intiTimeSelect(data, items) {
			var cellHeight = 60;
			var totalCellHeight = data.length * cellHeight;
			var fHeight = api.frameHeight * 0.1;
			var height = api.frameHeight * 0.7;
			var width = api.frameWidth;
			listViewObj.open({
				"x" : Math.ceil(width * 0.1),
				"y" : totalCellHeight > height ? Math.ceil(fHeight) : Math.ceil((api.frameHeight - totalCellHeight) / 2),
				"w" : Math.ceil(width * 0.8),
				"h" : totalCellHeight > height ? Math.ceil(height) : totalCellHeight,
				"cellBgColor" : "#FFF",
				"cellSelectColor" : "#f5f5f5",
				"cellHeight" : cellHeight,
				"data" : data
			}, function(ret, err) {
				if (ret.eventType !== "open") {
					console.log(JSON.stringify(ret));
					console.log(JSON.stringify(items[ret.index]));
					var manItem = items[ret.index];
					ensure(manItem.id, manItem.name(), manItem.area());
				}
			});
		}

		function goBack() {
			api.hideProgress();
			//var obj = api.require('listView');
			listViewObj.hide();
			api.closeFrame({
				name : 'manSelector'
			});
		}

		function rejectOrderOrNot() {
			console.log("manSelector_2.html")
			if (api.pageParam) {
				var query = new AV.Query(Order);
				query.get(api.pageParam.orderId).then(function(order) {
					api.confirm({
						title : '拒单注意',
						msg : '请谨慎拒单，建议拒单前先联系消费者',
						buttons : ['直接拒单', '联系买家', '取消']
					}, function(ret, err) {
						if (ret.buttonIndex == 1) {
							rejectingReason(api.pageParam.orderId);
						} else if (ret.buttonIndex == 2) {
							makeCustPhoneCall(api.pageParam.orderId);
						}
					});
				}).catch(function(error) {
					errorAlert(error);
				});
			}
		}

		function alertSound() {
			api.startPlay({
				path : 'widget://res/finishOrder.mp3'
			}, function() {
			});
		}

		function makeCustPhoneCall(orderId) {
			var query = new AV.Query(Order);
			query.include('customer');
			query.get(orderId).then(function(orderObj) {
				var mobilePhoneNum = orderObj.customer().mobilePhoneNumber();
				api.call({
					type : 'tel_prompt',
					number : mobilePhoneNum
				});
			}).catch(function(error) {
				errorAlert(error);
			});
		}

		function rejectingReason(orderId) {
			api.actionSheet({
				title : '拒单原因',
				cancelTitle : '取 消',
				//		destructiveTitle : ,
				buttons : ['买卖双方协商一致', '送餐地址不在配送范围内', '送餐地址信息不完整', '订单过多', '订单中的商品已售完']
			}, function(ret, err) {
				if (ret.buttonIndex == 1) {
					rejectingOrder(orderId, '买卖双方协商一致');
				} else if (ret.buttonIndex == 2) {
					rejectingOrder(orderId, '送餐地址不在配送范围内');
				} else if (ret.buttonIndex == 3) {
					rejectingOrder(orderId, '送餐地址信息不完整');
				} else if (ret.buttonIndex == 4) {
					rejectingOrder(orderId, '订单过多');
				} else if (ret.buttonIndex == 5) {
					rejectingOrder(orderId, '订单中的商品已售完');
				}
			});
		}

		function rejectingOrder(orderId, rejectReason) {
			var custJPushRegistrationId;
			api.showProgress({
				title : '正在拒单...',
				modal : true
			});
			var query = new AV.Query(Order);
			query.include('customer');
			query.get(orderId).then(function(order) {
				custJPushRegistrationId = order.customer().JPushRegistrationId();
				return AV.Cloud.run('updateOrderReject', {
					orderObjectId : order.id
				});
				//				order.set('status', '已拒单');
				//				order.set('orderTime', new Date());
				//				return order.save();
			}).then(function(order) {
				// 推送通知给customer
				//				ajPushToCustomer(custJPushRegistrationId, order.id, rejectReason);
				api.hideProgress();
				//				api.execScript({
				//					name : 'homeSlide',
				//					frameName : 'waitingList',
				//					script : 'reloadFrame();'
				//				});
				//				api.execScript({
				//					name : 'homeSlide',
				//					frameName : 'deliveringList',
				//					script : 'reloadFrame();'
				//				});
				//				api.execScript({
				//					name : 'homeSlide',
				//					frameName : 'otherDeliveringList',
				//					script : 'reloadFrame();'
				//				});
				//				api.execScript({
				//					name : 'homeSlide',
				//					frameName : 'finishedList',
				//					script : 'reloadFrame();'
				//				});
				//				api.execScript({
				//					name : 'homeSlide',
				//					script : 'getOrdersByType();'
				//				});
				api.toast({
					msg : '拒单成功！',
					location : 'middle',
					duration : 1000
				});
				alertSound();
				setTimeout(function() {
					goBack();
				}, 1000);
			}).catch(function(order, error) {
			});
		}

		function ensure(manId, manName, manArea) {
			if (api.pageParam) {
				if (api.pageParam.orderType == 1) {
					var query = new AV.Query(Order);
					query.get(api.pageParam.orderId).then(function(order) {
						api.confirm({
							title : '接单注意',
							msg : '是否确定派单到 ' + manArea + ' ' + manName,
							buttons : ['取消', '确定']
						}, function(ret, err) {
							if (ret.buttonIndex == 2) {
								saveDeliveryMan(api.pageParam.orderId, manId, manName);
							}
						});
					}).catch(function(error) {
						errorAlert(error);
					});
				} else if (api.pageParam.orderType == 2) {
					console.log("api.pageParam.orderId>>>" + api.pageParam.orderId)
					var query = new AV.Query(deliveryOrder);
					query.get(api.pageParam.orderId).then(function(order) {
						api.confirm({
							title : '接单注意',
							msg : '是否确定派单到 ' + manArea + ' ' + manName,
							buttons : ['取消', '确定']
						}, function(ret, err) {
							if (ret.buttonIndex == 2) {
								saveDeliveryMan2(api.pageParam.orderId, manId, manName);
							}
						});
					}).catch(function(error) {
						errorAlert(error);
					});
				}
			}
		}

		function saveDeliveryMan2(orderId, manId, manName) {
			console.log("manId>>>" + manId)
			api.showProgress({
				title : '正在派单...',
				modal : true
			});
			var request = {
				id : orderId,
				man : manId,
				status : 1
			};
			AV.Cloud.run("updateDeliveryOrderStatus", request).then(function(prior) {
				console.log("prior>>>" + JSON.stringify(prior))
				api.hideProgress();
				api.toast({
					msg : '派单成功',
					locaion : "middle"
				});
				setTimeout(function() {
					goBack();
				}, 1000);
			}).catch(function(erroer) {
				console.log("erroer>>>" + JSON.stringify(erroer))
				api.toast({
					msg : '派单失败,请联系管理员',
					locaion : "middle"
				});
				api.hideProgress();
				errorAlert(error);
			}); 
		}

		function saveDeliveryMan(orderId, manId, manName) {
			api.showProgress({
				title : '正在派单...',
				modal : true
			});
			var logName = $api.getStorage("useName");
			var query = new AV.Query(Order);
			query.include('customer');
			query.include('cafeCar');
			query.get(orderId).then(function(order) {
				var carName = order.cafeCar().name();
				var request = {
					orderId : order.id,
					carId : order.cafeCar().id,
					deliveryManId : manId
				};
				console.log("saveDeliveryMan>>>request>>>" + JSON.stringify(request))
				AV.Cloud.run('assignDeliveryMan', request).then(function(order) {
					api.execScript({
						name : 'homeSlide',
						script : 'getOrdersByType();'
					});
					api.hideProgress();
					api.toast({
						msg : '接单成功！',
						location : 'middle',
						duration : 1000
					});
					console.log("logName>>>" + logName + ":" + manName)
					if (logName != manName) {
						console.log("别人分配单给你啦");
						alertSound()
					}
					setTimeout(function() {
						goBack();
					}, 1000);
				}).catch(function(error) {
					api.hideProgress();
					api.alert({
						title : '接单失败',
						msg : JSON.stringify(error),
						buttons : ['确定']
					}, function(ret, err) {
					});
				});
			}).catch(function(error) {
				api.hideProgress();
				errorAlert(error);
			});
		}

		function checkDeliveryManCartIsLacked(manId) {
			var hasProp = false;
			var lessThan = false;
			var query = new AV.Query(DeliveryMan);
			return query.get(manId).then(function(manObj) {
				for (var dish in manObj.cart()) {
					hasProp = true;
					if (manObj.cart()[dish] < 0) {
						lessThan = true;
					}
				}
				if (!hasProp || lessThan) {
					return AV.Promise.as(true);
				} else {
					return AV.Promise.as(false);
				}
			}).catch(function(error) {
				return AV.Promise.error(error);
			});
		}

		function checkCafeCarCartIsLacked(carId) {
			var hasProp = false;
			var lessThan = false;
			var query = new AV.Query(CafeCar);
			return query.get(carId).then(function(carObj) {
				for (var dish in carObj.cart()) {
					hasProp = true;
					if (carObj.cart()[dish] < 0) {
						lessThan = true;
					}
				}
				if (!hasProp || lessThan) {
					return AV.Promise.as(true);
				} else {
					return AV.Promise.as(false);
				}
			}).catch(function(error) {
				return AV.Promise.error(error);
			});
		}

		function goInventory(manId) {
			api.openWin({
				name : 'manInventory',
				url : '../html/manInventory.html',
				rect : {
					x : 0,
					y : 0,
					w : 'auto',
					h : 'auto'
				},
				pageParam : {
					manId : manId
				},
				reload : true,
				opaque : true,
				bounces : false,
				delay : 0
			});
		}

		function goCarInventory(carId) {
			console.log("carId" + carId);
			api.openWin({
				name : 'myInventory',
				url : '../html/myInventory.html',
				rect : {
					x : 0,
					y : 0,
					w : 'auto',
					h : 'auto'
				},
				pageParam : {
					carId : carId
				},
				reload : true,
				opaque : true,
				bounces : false,
				delay : 0
			});
		}
	</script>
</html>
