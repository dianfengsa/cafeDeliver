<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>QRCode</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/displayQRCode.css" />
	</head>
	<body>
		<div class="qrCode" onclick="goBack();">
			<img src="../image/empty_page_nothing.png" id="qrCode" />
		</div>
		<div class="receiptBtn" onclick="goBack();">
			<span>返  回</span>
		</div>
		<!--<div class="receiptBtn" onclick="ensure();">
		<span>我要自己收货</span>
		</div>-->
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script>
		apiready = function() {
			api.addEventListener({
				name : 'keyBack'
			}, function(ret, err) {
				goback();
			});
			if (api.pageParam) {
				var orderId = api.pageParam.orderId;
				loadQRCode(orderId);
			}
		}
		function goBack() {
			api.closeFrame({
				name : 'qrCode'
			});
		}

		function loadQRCode(orderId) {
			var imgName = orderId + '.png';
			var obj = api.require('scanner');
			obj.encode({
				string : orderId,
				save : {
					album : false,
					imgPath : 'fs://qrCodeImage',
					imgName : imgName,
					size : 200
				}
			}, function(ret, err) {
				// 生成成功打印二维码图片路径，并且打印二维码
				if (ret.status) {
					var path = api.fsDir + '/qrCodeImage/' + imgName;
					document.getElementById('qrCode').src = path;
					document.getElementById('qrCode').style.zIndex = 100;
				} else {
					var path = '../image/empty_page_nothing.png';
					document.getElementById('qrCode').src = path;
				}
			});
		}

		function ensure() {
			api.confirm({
				title : '提示',
				msg : '是否确定收货',
				buttons : ['取消', '确定']
			}, function(ret, err) {
				if (ret.buttonIndex == 2) {
					receiptTmp();
				}
			});
		}

		function receiptTmp() {
			if (api.pageParam) {
				api.showProgress({
					title : '订单收货中...',
					modal : true
				});
				var orderId = api.pageParam.orderId;
				var custId = api.pageParam.custId;
				console.log(custId);
				AV.Cloud.run('receiptTemp', {
					orderId : orderId,
					userId : custId
				}, {
					success : function(order) {
						api.hideProgress();
						api.alert({
							title : '提示',
							msg : '订单收货成功',
							buttons : ['确定']
						}, function(ret, err) {
							if (ret.buttonIndex == 1) {
								goBack();
							}
						});
					},
					error : function(error) {
						api.hideProgress();
						errorAlert(error);
					}
				});
			}
		}
	</script>
</html>
