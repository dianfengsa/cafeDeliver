<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>区域信息</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/manInfo.css" />
		<style>
			ul > li {
				line-height: 40px;
				font-weight: bold;
				color: rgb(47, 45, 44);
			}
			ul > li span {
				padding-left: 1em;
			}
		</style>
	</head>
	<body>
		<div class="topBack">
			<img class="bg" src="../image/bg_003.png" alt="" />
		</div>
		<div class="header" id="header">
			<div class="backIcon" onclick="goBack();"><img src="../image/deliver/icon_back.png" alt="" />
			</div>
			<div class="title">
				<span>配送信息</span>
			</div>
			<div class="saveBtn" id="saveBtn">
				<span>保 存</span>
			</div>
		</div>
		<div class="middleInfo">
			<div class="h10"></div>
			<div class="carInfo">
				<div class="carImg" style="" id="carImg">
					<span id="none"></span>
				</div>
				<div class="contact">
					<div class="carName">
						<span id="carName">暂无</span>
					</div>
					<div class="mobile">
						电话：<span id="telNum">暂无</span>
					</div>
				</div>
				<div class="mobileImg" onclick="makePhoneCall();">
					<img src="../image/deliver/phone.png" alt="" />
				</div>
			</div>
			<!--<div class="item">
			<div class="itemName">
			<span>区域状态:</span>
			</div>
			<div class="content">
			<span id="status">暂无</span>
			</div>
			</div>
			<div class="h2"></div>-->
		</div>
		<div style="position: absolute;background-color: rgba(255, 255, 255, 0.49);width: 100%;height: 60%;">
			<ul style="  padding: 8%;">
				<li>
					区域状态:<span id="status"></span>
				</li>
				<li>
					区域地点:<span id="parkingAddress"></span>
				</li>
				<li>
					员工姓名:<input type="text" style="padding-left: 1em;  width: 100px;" id="name" value="" onchange="setSaveBtnActive();"></input>
				</li>
				<li>
					手机号码:<span  id="manTel"  onchange="setSaveBtnActive();"  disabled="disabled"></span>
				</li>
				<li>
					配送区域:<span  id="area"  onchange="setSaveBtnActive();"></span>
				</li>
			</ul>
		</div>
		<!--<div class="bottomInfo">
		<div class="h2"></div>
		<div class="item">
		<div class="itemName">
		<span>区域地点:</span>
		</div>
		<div class="content">
		<span id="parkingAddress">暂无</span>
		</div>
		</div>
		<div class="item">
		<div class="itemName">
		<span>员工姓名:</span>
		</div>
		<div class="content">
		<input type="text" id="name" value="" onchange="setSaveBtnActive();">
		</input>
		</div>
		</div>
		<div class="h2"></div>
		<div class="item">
		<div class="itemName">
		<span>手机号码:</span>
		</div>
		<div class="content">
		<input type="text" id="manTel" value="" onchange="setSaveBtnActive();" disabled="disabled">
		15916315258
		</input>
		</div>
		</div>
		<div class="h2"></div>
		<div class="item2">
		<div class="itemName">
		<span>配送区域:</span>
		</div>
		<div class="content2" id="area"  onchange="setSaveBtnActive();">
		暂无
		</div>
		</div>
		</div>-->
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script>
		apiready = function() {
			api.addEventListener({
				name : 'keyback'
			}, function(ret, err) {
				goBack();
			});
			updateCafeCarInfo();
			updateManInfo();
		}
		function updateCafeCarInfo() {
			window.header = $api.byId('header');
			$api.fixStatusBar(header);
			var query = new AV.Query(DeliveryMan);
			query.include('cafeCar');
			query.equalTo('owner', AV.User.current());
			query.first().then(function(manInfo) {
				var carInfo = manInfo.cafeCar();
				if (carInfo != 'undefined') {
					document.getElementById('none').inneHTML = '';
					document.getElementById('carImg').style.backgroundImage = 'url(../image/cust.png)';
					document.getElementById('carName').innerHTML = carInfo.name();
					document.getElementById('telNum').innerHTML = carInfo.mobile();
					document.getElementById('status').innerHTML = carInfo.status();
					document.getElementById('parkingAddress').innerHTML = carInfo.parkingAddress();
					//					if (carInfo.radius > 1000) {
					//						var radius = accDiv(carInfo.radius(), 1000);
					//						document.getElementById('radius').innerHTML = radius + ' km';
					//					} else {
					//						document.getElementById('radius').innerHTML = carInfo.radius() + ' m';
					//					}
				} else if (carInfo == 'undefined') {
					api.toast({
						msg : '当前用户尚未在该区域注册',
						location : 'bottom',
						duration : 2000
					});
					document.getElementById('none').innerHTML = '无';
					document.getElementById('carImg').style.backgroundImage = '';
				}
			});
		}

		function makePhoneCall() {
			var telNum = document.getElementById('telNum').innerHTML;
			if (telNum) {
				api.call({
					type : 'tel_prompt',
					number : telNum
				});
			}
		}

		function updateManInfo() {
			//			window.header = $api.byId('header');
			//			$api.fixStatusBar(header);
			var query = new AV.Query(DeliveryMan);
			query.equalTo('owner', AV.User.current());
			query.first().then(function(manInfo) {
				console.log("manInfo>>>" + JSON.stringify(manInfo))
				document.getElementById('name').value = manInfo.name();
				document.getElementById('manTel').innerHTML = manInfo.mobilePhoneNumber();
				document.getElementById('area').innerHTML = manInfo.area();
			});
		}

		function setSaveBtnActive() {
			document.getElementById('saveBtn').className = 'saveBtn-active';
			document.getElementById('saveBtn').setAttribute('onclick', 'alterAreaOrNot();');
		}

		function alterAreaOrNot() {
			var area = document.getElementById('area').innerHTML, manName = document.getElementById('name').value;
			api.confirm({
				title : '提示',
				msg : '是否确定修改配送员信息？',
				buttons : ['取消', '确定']
			}, function(ret, err) {
				if (ret.buttonIndex == 2) {
					alterManInfo(area, manName);
				}
			});
		}

		function alterManInfo(area, manName) {
			console.log("manName>>>" + manName.length)
			if (manName.length < 5) {
				api.showProgress({
					title : '配送员信息更新中...',
					modal : false
				});
				var query = new AV.Query(DeliveryMan);
				query.equalTo('owner', AV.User.current());
				query.first().then(function(manObj) {
					if (manObj) {
						manObj.set('area', area);
						manObj.set('name', manName);
						manObj.save().then(function(manObj) {
							$api.setStorage('manInfo', manObj);
							api.hideProgress();
							//						updateHomeFixed();
							//						goBack();
							window.location.reload();
						}).catch(function(error) {
							api.hideProgress();
							errorAlert(error);
						});
					} else if (!manObj) {
						api.hideProgress();
						api.toast({
							msg : '当前登录无效，请重新登录',
							location : 'middle',
							duration : 2000
						});
						AV.User.logOut();
						api.openWin({
							name : 'login',
							url : '../new_login.html',
							opaque : true, // 页面不透明
							bounces : false, // 不允许页面弹动
							reload : true,
							delay : 2000
						});
					}
				}).catch(function(error) {
					api.hideProgress();
					errorAlert(error);
				});
			} else {
				api.toast({
					msg : '您老是外星人?取个地球人名字吧!'
				});
			}
		}

		function goBack() {
			api.closeWin({
			});
		}
	</script>
</html>
