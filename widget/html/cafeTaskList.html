<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="format-detection" content="telephone=no"/>
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>简略进货单列表</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/cafeTaskList.css" />
	</head>
	<body>
		<!--<div class="orderItem" id="itemID{{=it[i].order.objectId()}}">
		<div class="aboutInfo">
		<div class="orderInfo">
		<div class="infoRow">
		<div class="contactInfo">
		补单（等待拿货）<span>午餐</span>
		</div>
		</div>
		<div class="infoRow">
		<div class="areaIcon">
		<img src="../image/deliver/areaMark.png" alt="" />
		</div>
		<div class="address">
		<span>荷花田吉大旗舰店</span>
		</div>
		</div>
		<div class="infoRow">
		<div class="include">
		<span>执行时间：</span>
		<div class="timeItem">
		<span>2010年2月12日</span>
		</div>
		</div>
		</div>
		</div>
		<div style=" clear:both;"></div>
		</div>
		<div class="detail">
		<table class="cartInfo">
		{{ if(it[i].cart && it[i].cart.length>0){ }}
		{{ for(var k=0; k<it[i].cart.length; k++){ }}
		<tr class="dishItem">
		<td class="dishName"> 辣子鸡 </td>
		<td class="num"> X 2 </td>
		</tr>
		{{ } }}
		{{ } }}
		</table>
		<div class="merge">
		<div class="totalNum">
		共 <span id="totalNum{{=it[i].order.objectId()}}">2</span> 份
		</div>
		<div style=" clear:both;"></div>
		</div>
		<div class="h1"></div>
		<div class="remarks">
		备注:<span>你好吗</span>
		</div>
		</div>
		</div>
		<div class="h10"></div>-->
		<script type="text/template" id="template_orderItem">
			{{ if(it && it.length>0){ }}
			{{ for(var i=0; i<it.length; i++){ }}
			<div class="orderItem" id="itemID{{=it[i].task.id}}">
			<div class="aboutInfo">
			<div class="orderInfo">
			<div class="infoRow">
			<div class="contactInfo">
			{{=it[i].task.get('type')}}（{{=it[i].task.get('status')}}）<span>{{=it[i].task.get('officeHoursType')}}</span>
			</div>
			</div>
			<div class="infoRow" style="font-weight: bold;">
			进货单号：{{=it[i].task.id}}
			</div>
			<div class="infoRow">
			<div class="areaIcon">
			<img src="../image/deliver/areaMark.png" alt="" />
			</div>
			<div class="address">
			<span>{{=it[i].task.get('cafeKitchen').get('name')}}</span>
			</div>
			</div>
			<div class="infoRow">
			<div class="include">
			<span>执行时间：</span>
			<div class="timeItem">
			<span>{{=new Date().format(it[i].task.get('executionDate'),"dateTime",0)}}</span>
			</div>
			</div>
			</div>
			</div>
			<div style=" clear:both;"></div>
			</div>
			<div class="detail">
			<table class="cartInfo">
			<tr class="dishItem">
			<td class="dishName"> 菜名 </td>
			<td class="num"> 进货价 </td>
			<td class="num"> 数量 </td>
			</tr>
			{{ if(it[i].cart && it[i].cart.length>0){ }}
			{{ for(var k=0; k<it[i].cart.length; k++){ }}
			<tr class="dishItem">
			<td class="dishName"> {{=it[i].cart[k].name}} </td>
			<td class="num"> {{=changeTwoDecimal_f(it[i].cart[k].purchasePrice)}} </td>
			<td class="num"> X {{=it[i].cart[k].num}} </td>
			</tr>
			{{ } }}
			{{ } }}
			</table>
			<div class="merge">
			<div class="totalNum">
			共 <span id="totalNum{{=it[i].task.id}}">{{=it[i].totalNum}}</span> 份
			</div>
			<div style=" clear:both;"></div>
			</div>
			<div class="h1"></div>
			<div class="remarks">
			备注:<span></span>
			</div>
			</div>
			</div>
			<div class="h10"></div>
			{{ } }}
			{{ } }}
		</script>
		<div class="orderList_simple" id="orderList_simpleDiv"></div>
		<div class="emptyOrder" id="emptyDiv" >
			<img src="../image/empty_page_nothing.png" alt="" />
			<div class="emptyAlert" id="emptyAlertDiv">
				今日尚无进货单
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script type="text/javascript" src="../script/doT.min.js"></script>
	<script type="text/javascript" src="../script/date.format.js"></script>
	<script type="text/javascript" src="../script/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="../script/timeago.js"></script>
	<script>
		var orderCount = 0, hasLoad = 0;
		apiready = function() {
			//			api.addEventListener({
			//				name : 'swipeleft'
			//			}, function(ret, err) {
			//				var frameIndex = $api.getStorage('frameIndex');
			//				var index = (frameIndex + 3) % 4;
			//				changeOrderList(index);
			//			});
			//			api.addEventListener({
			//				name : 'swiperight'
			//			}, function(ret, err) {
			//				var frameIndex = $api.getStorage('frameIndex');
			//				var index = (frameIndex + 1) % 4;
			//				changeOrderList(index);
			//			});
			api.setRefreshHeaderInfo({
				visible : true,
				bgColor : '#EFEFEF',
				textDown : '刷新进货单..',
				textUp : '刷新进货单..',
				textLoading : '数据加载中..'
			}, function(ret, err) {
				document.getElementById('orderList_simpleDiv').innerHTML = '';
				orderCount = 0;
				hasLoad = 0;
				getOrders(api.pageParam.catalog, api.pageParam.hoursType).then(function() {
					api.refreshHeaderLoadDone();
				}).catch(function(error) {
					api.refreshHeaderLoadDone();
					errorAlert(error);
				});
			});
			if (AV.User.current()) {
				api.showProgress({
					title : '订单列表获取中...',
					modal : false
				});
				getOrders(api.pageParam.catalog, api.pageParam.hoursType).then(function() {
					api.hideProgress();
				}).catch(function(error) {
					api.hideProgress();
					errorAlert(error);
				});
			} else {
				api.toast({
					msg : '当前登录无效，请重新登录',
					location : 'middle',
					duration : 2000
				});
				AV.User.logOut();
				api.openWin({
					name : 'login',
					url : '../new_login.html',
					opaque : true, // 页面不透明
					bounces : false, // 不允许页面弹动
					reload : true,
					delay : 2000
				});
			}
		}
		function getOrders(catalog, hoursType) {
			console.log("getOrders>>>" + JSON.stringify(api.pageParam));
			//必须登录
			var queryMan = new AV.Query(DeliveryMan);
			queryMan.equalTo('owner', AV.User.current());
			queryMan.equalTo("cafeCar");
			return queryMan.first().then(function(manObj) {
				var carObj = manObj.cafeCar();
				var query = new AV.Query(CafeTask);
				// mark优先显示
				query.include('cafeKitchen');
				query.equalTo('cafeCar', carObj);
				if (catalog != 0) {//兼容之前数据
					query.equalTo('catalog', catalog);
				}
				query.equalTo('officeHoursType', hoursType);
				query.containedIn('type', ['补单', '预下单']);
				var myDate = new Date(), tomorrow = new Date();
				tomorrow.setDate(tomorrow.getDate() + 1);
				myDate.setHours(0, 0, 0, 0);
				tomorrow.setHours(0, 0, 0, 0);
				// 今日付款
				query.greaterThanOrEqualTo('executionDate', myDate);
				query.lessThanOrEqualTo('executionDate', tomorrow);
				// 派单优先
				query.ascending('executionDate');
				return query.find();
			}).then(function(ret) {
				console.log("getOrders>>>" + JSON.stringify(ret));
				if (ret.length > 0) {
					document.getElementById('emptyDiv').hidden = true;
					// 显示结果
					return getTaskDetails(ret).then(function(tasks) {
						insertTaskItem(tasks);
						summaryTask(tasks,api.pageParam.hoursType);
						return AV.Promise.as();
					}).catch(function(error) {
						return AV.Promise.error(error);
					});
				} else {
					summaryTask(new Array(),api.pageParam.hoursType);
					return AV.Promise.as();
				}
			}).catch(function(error) {
				return AV.Promise.error(error);
			});
		}

		function getTaskDetails(tasks) {
			var taskDetails = new Array();
			var promise = AV.Promise.as();
			tasks.forEach(function(item) {
				promise = promise.then(function() {
					return getCartDetails(item).then(function(cartDetails) {
						var total = 0;
						for ( i = 0; i < cartDetails.length; i++) {
							total += Math.abs(cartDetails[i].num);
						}
						var taskInfo = {
							task : item,
							cart : cartDetails,
							totalNum : total
						}
						taskDetails.push(taskInfo);
						return taskDetails;
					}).catch(function(error) {
						return AV.Promise.error(error);
					});
				});
			});
			return promise;
		}

		function insertTaskItem(items) {
			console.log(JSON.stringify(items));
			var template = document.getElementById('template_orderItem').innerHTML;
			document.getElementById('orderList_simpleDiv').innerHTML = doT.template( template )(items);
		}

		function summaryTask(tasks,type) {
			var total = 0;
			for ( i = 0; i < tasks.length; i++) {
				total += Number(tasks[i].totalNum);
			}
			api.execScript({
				name : 'tasksTrack',
				script : 'showTotal("' + type + '",' + total +');'
			});
		}

		//		function summaryTask(tasks) {
		//			var breakfast = 0, lunch = 0, dinner = 0;
		//			for ( i = 0; i < tasks.length; i++) {
		//				var type = tasks[i].task.get('officeHoursType');
		//				if (type == "早餐") {
		//					breakfast += parseInt(tasks[i].totalNum);
		//				} else if (type == "午餐") {
		//					lunch += parseInt(tasks[i].totalNum);
		//				} else if (type == "晚餐") {
		//					dinner += parseInt(tasks[i].totalNum);
		//				}
		//			}
		//			api.execScript({
		//				name : 'tasksTrack',
		//				script : 'loadSum(' + breakfast + ',' + lunch + ',' + dinner + ');'
		//			});
		//		}
		//		function makePhoneCall(telNum) {
		//			api.call({
		//				type : 'tel_prompt',
		//				number : telNum
		//			});
		//		}
	</script>
</html>
