<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>更改配送区域</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/alterArea.css" />
	</head>
	<body>
		<div class="topBack">
			<img class="bg" src="../image/bg_003.png" alt="" />
		</div>
		<div class="header" id="header">
			<div class="backIcon" onclick="goBack();"><img src="../image/deliver/icon_back.png" alt="" />
			</div>
			<div class="title">
				<span>更改配送区域</span>
			</div>
			<div class="saveBtn" id="saveBtn">
				<span>保 存</span>
			</div>
		</div>
		<div class="middleInfo">
			<div class="h10"></div>
			<div class="h10"></div>
			<div class="h1"></div>
			<div class="item2">
				<div class="itemName">
					<span>配送区域</span>
				</div>
				<div class="content2">
					<textarea cols="20" type="text" id="area" value="" onchange="setSaveBtnActive();">
					</textarea >
				</div>
			</div>
			<div class="h1"></div>
		</div>
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/av.min.js"></script>
	<script type="text/javascript" src="../script/AV_common.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script>
		apiready = function() {
			api.addEventListener({
				name : 'keyback'
			}, function(ret, err) {
				goBack();
			});
			updateDeliveryManArea();
		}
		function updateDeliveryManArea() {
			window.header = $api.byId('header');
			$api.fixStatusBar(header);
			var query = new AV.Query(DeliveryMan);
			query.equalTo('owner', AV.User.current());
			query.first().then(function(manInfo) {
				document.getElementById('area').value = manInfo.area();
			});
		}

		function setSaveBtnActive() {
			document.getElementById('saveBtn').className = 'saveBtn-active';
			document.getElementById('saveBtn').setAttribute('onclick', 'alterAreaOrNot();');
		}

		function alterAreaOrNot() {
			var area = document.getElementById('area').value;
			api.confirm({
				title : '提示',
				msg : '是否确定设置 ' + area + ' 为配送区域',
				buttons : ['取消', '确定']
			}, function(ret, err) {
				if (ret.buttonIndex == 2) {
					alterArea(area);
				}
			});
		}

		function alterArea(area) {
			api.showProgress({
				title : '配送范围更新中...',
				modal : false
			});
			var query = new AV.Query(DeliveryMan);
			query.equalTo('owner', AV.User.current());
			query.first().then(function(manObj) {
				if (manObj) {
					manObj.set('area', area);
					manObj.save().then(function(manObj) {
						$api.setStorage('manInfo', manObj);
						api.hideProgress();
						updateHomeFixed();
						goBack();
					}).catch(function(error) {
						api.hideProgress();
						errorAlert(error);
					});
				} else if (!manObj) {
					api.hideProgress();
					api.toast({
						msg : '当前登录无效，请重新登录',
						location : 'middle',
						duration : 2000
					});
					AV.User.logOut();
					api.openWin({
						name : 'login',
						url : '../new_login.html',
						opaque : true, // 页面不透明
						bounces : false, // 不允许页面弹动
						reload : true,
						delay : 2000
					});
				}
			}).catch(function(error) {
				api.hideProgress();
				errorAlert(error);
			});
		}

		function goBack() {
			api.closeWin({
			});
		}

		function updateHomeFixed() {
			api.execScript({
				name : 'homeFixed',
				script : 'updateDeliveryManInfo();'
			});
		}
	</script>
</html>
